<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ST Card Manager - MuteFun Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ JSZip ç”¨äºæ‰“åŒ…ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* åŸºç¡€é…è‰² - ä»¿ MuteFun ç™½æ¿é£æ ¼ */
        :root {
            --bg-body: #F3F4F6;       /* æµ…ç°èƒŒæ™¯ */
            --bg-card: #FFFFFF;       /* çº¯ç™½å¡ç‰‡ */
            --bg-sidebar: #FFFFFF;    /* ä¾§è¾¹æ  */
            --text-main: #1F2937;     /* æ·±ç°æ–‡å­— */
            --text-sub: #6B7280;      /* æ¬¡è¦æ–‡å­— */
            --accent: #F43F5E;        /* ç«ç‘°çº¢å¼ºè°ƒè‰² (ä»¿å‚è€ƒå›¾) */
            --accent-hover: #E11D48;
            --accent-light: #FFE4E6;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* å¡ç‰‡é˜´å½±ä¸è¿‡æ¸¡ */
        .card-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .card-shadow:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .card-selected { ring: 3px solid var(--accent); transform: translateY(-2px); }

        /* ç¼–è¾‘é¢æ¿æ»‘å…¥åŠ¨ç”» */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }

        /* æ‹–æ‹½é«˜äº® */
        .drag-over { background-color: var(--accent-light); border: 2px dashed var(--accent); }

        [v-cloak] { display: none; }
        
        /* å·®å¼‚å¯¹æ¯”é«˜äº® */
        .diff-highlight { background-color: #FEF2F2; border-color: #FECACA; }

        /* é¢„è§ˆæ¨¡å¼ä¸‹çš„æ ·å¼é‡ç½®ï¼Œé˜²æ­¢ tailwind å¹²æ‰°å†…éƒ¨ HTML */
        .st-preview-content { font-family: sans-serif; line-height: 1.6; }
        .st-preview-content p { margin-bottom: 0.5em; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="h-screen overflow-hidden">

<div id="app" v-cloak class="h-full flex">
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-8 h-8 bg-rose-500 rounded-lg flex items-center justify-center text-white shadow-lg shadow-rose-200">
                <i data-lucide="zap" class="w-5 h-5"></i>
            </div>
            <h1 class="font-black text-xl tracking-tighter italic">ST MANAGER</h1>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- åŸºç¡€è§†å›¾ -->
            <div class="space-y-1">
                <div class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">èµ„æ–™åº“</div>
                <button @click="viewMode = 'all'; currentTag = null" :class="['w-full flex items-center justify-between px-3 py-2 rounded-xl font-bold transition-all duration-200', viewMode === 'all' && !currentTag ? 'bg-rose-50 text-rose-600' : 'text-gray-500 hover:bg-gray-50']">
                    <span class="flex items-center gap-2"><i data-lucide="layout-grid" class="w-4 h-4"></i> å…¨éƒ¨æ¡£æ¡ˆ</span>
                    <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full text-gray-400">{{cards.length}}</span>
                </button>
                <button @click="viewMode = 'duplicates'" :class="['w-full flex items-center justify-between px-3 py-2 rounded-xl font-bold transition-all duration-200 mt-1', viewMode === 'duplicates' ? 'bg-orange-50 text-orange-600' : 'text-gray-500 hover:bg-gray-50']">
                    <span class="flex items-center gap-2"><i data-lucide="rows" class="w-4 h-4"></i> é‡å¤ç­›é€‰</span>
                    <span class="text-xs bg-orange-100 px-2 py-0.5 rounded-full text-orange-400">{{duplicateCount}}</span>
                </button>
            </div>

            <!-- iOSé£æ ¼æ–‡ä»¶å¤¹ç³»ç»Ÿ -->
            <div class="space-y-1">
                <div class="px-3 flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æˆ‘çš„æ”¶è—å¤¹ (Folders)</span>
                    <button @click="openFolderModal('create')" class="p-1 text-gray-400 hover:text-rose-500 hover:bg-rose-50 rounded transition">
                        <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
                <div class="space-y-1 px-1">
                    <div v-for="(folder, idx) in customFolders" :key="folder"
                        @click="toggleTag(folder)"
                        @contextmenu.prevent="selectedFolderForExport = (selectedFolderForExport === folder ? null : folder)"
                        @drop="onDropToFolder($event, folder)"
                        @dragover.prevent
                        @dragenter.prevent="dragEnterFolder"
                        @dragleave="dragLeaveFolder"
                        :class="['w-full flex items-center justify-between px-3 py-2.5 rounded-xl text-xs font-bold transition-all cursor-pointer border', 
                                 selectedFolderForExport === folder ? 'bg-purple-100 text-purple-700 border-purple-300 ring-2 ring-purple-200' : 
                                 currentTag === folder ? 'bg-blue-50 text-blue-600 border-blue-100' : 'text-gray-600 hover:bg-gray-50 border-transparent']">
                        <div class="flex items-center gap-2.5">
                            <i data-lucide="folder-closed" class="w-4 h-4" :class="selectedFolderForExport === folder ? 'fill-purple-200 text-purple-500' : currentTag === folder ? 'fill-blue-200 text-blue-500' : 'text-gray-400'"></i>
                            <span class="truncate max-w-[120px]">{{folder}}</span>
                        </div>
                        <div class="flex items-center gap-2 group">
                             <span v-if="selectedFolderForExport === folder" class="text-[9px] bg-purple-200 text-purple-700 px-1.5 py-0.5 rounded-full font-bold">å¯¼å‡º</span>
                             <span v-else class="text-[10px] text-gray-300">{{ getFolderCount(folder) }}</span>
                             <button @click.stop="openFolderModal('edit', folder, idx)" class="text-gray-300 hover:text-blue-500 p-1 rounded-md hover:bg-blue-50 transition-all">
                                <i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
                             </button>
                        </div>
                    </div>
                    <div v-if="customFolders.length === 0" class="px-4 py-4 text-center border-2 border-dashed border-gray-100 rounded-xl">
                        <p class="text-[10px] text-gray-400">ç‚¹å‡» + æ–°å»ºæ–‡ä»¶å¤¹<br>æ‹–æ‹½å¡ç‰‡è‡³æ­¤å½’æ¡£</p>
                    </div>
                    <div v-if="customFolders.length > 0" class="px-4 py-3 text-center bg-amber-50 rounded-lg mx-2 border border-amber-200">
                        <p class="text-xs text-amber-700 font-medium">ğŸ’¡ å³é”®ç‚¹å‡»æ–‡ä»¶å¤¹å¯é€‰æ‹©å¯¼å‡º</p>
                    </div>
                </div>
            </div>

            <!-- è‡ªåŠ¨æ ‡ç­¾ç´¢å¼• -->
            <div class="space-y-2 pt-2 border-t border-dashed border-gray-100">
                <div class="px-3 flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æ ‡ç­¾äº‘ ({{allTags.length}})</span>
                    <div class="flex items-center gap-1">
                        <button @click="tagManageMode = !tagManageMode" :class="tagManageMode ? 'text-rose-500 bg-rose-100' : 'text-gray-400 hover:bg-gray-100'" class="p-1 rounded transition-colors" title="ç®¡ç†æ ‡ç­¾">
                            <i data-lucide="settings-2" class="w-3 h-3"></i>
                        </button>
                        <button @click="showTagSection = !showTagSection" :class="showTagSection ? 'text-gray-600' : 'text-gray-400'" class="p-1 hover:bg-gray-100 rounded transition-colors" title="å±•å¼€/æ”¶èµ·">
                            <i :data-lucide="showTagSection ? 'chevron-up' : 'chevron-down'" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                
                <div v-if="showTagSection" class="flex flex-wrap gap-1.5 px-1">
                    <template v-for="tag in allTags" :key="tag.name">
                        <template v-if="!customFolders.includes(tag.name)">
                            <button v-if="!tagManageMode" 
                                @click="toggleTag(tag.name)"
                                :class="['px-2 py-1 rounded-lg border text-[10px] font-medium transition', 
                                         currentTag === tag.name ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-100 hover:border-gray-300']">
                                {{tag.name}} <span class="opacity-40 ml-0.5">{{tag.count}}</span>
                            </button>
                            
                            <div v-else class="flex items-center bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 gap-2">
                                <span class="text-[10px] font-medium text-gray-700">{{tag.name}}</span>
                                <div class="flex gap-1">
                                    <button @click="renameTag(tag.name)" class="text-blue-500 hover:bg-blue-100 rounded p-0.5"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button @click="deleteTag(tag.name)" class="text-red-500 hover:bg-red-100 rounded p-0.5"><i data-lucide="trash" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
            
            <!-- Quick Replies ç®¡ç†åŒºåŸŸ -->
            <div class="space-y-2 pt-2 border-t border-dashed border-gray-100">
                <div class="px-3 flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                        <i data-lucide="zap" class="w-3 h-3"></i>
                        å¿«é€Ÿå›å¤ QR ({{availableQRs.length}})
                    </span>
                    <div class="flex items-center gap-1">
                        <button @click="qrManageMode = !qrManageMode" :class="qrManageMode ? 'text-purple-500 bg-purple-100' : 'text-gray-400 hover:bg-gray-100'" class="p-1 rounded transition-colors" title="ç®¡ç†QR">
                            <i data-lucide="settings-2" class="w-3 h-3"></i>
                        </button>
                        <button @click="showQRSection = !showQRSection" :class="showQRSection ? 'text-purple-500' : 'text-gray-400'" class="p-1 hover:bg-gray-100 rounded transition-colors" title="å±•å¼€/æ”¶èµ·">
                            <i :data-lucide="showQRSection ? 'chevron-up' : 'chevron-down'" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                
                <div v-if="showQRSection" class="px-1 space-y-2">
                    <div v-if="availableQRs.length === 0" class="px-4 py-4 text-center border-2 border-dashed border-purple-100 rounded-xl bg-purple-50/30">
                        <p class="text-[10px] text-gray-400">å¯¼å…¥æ–‡ä»¶å¤¹æ—¶ä¼šè‡ªåŠ¨è¯†åˆ« QR<br>æˆ–æ‰‹åŠ¨å¯¼å…¥ .json æ–‡ä»¶</p>
                    </div>
                    
                    <!-- QR åˆ—è¡¨ - å¯æ‹–æ‹½å’Œå¤šé€‰ -->
                    <div v-for="(qr, idx) in availableQRs" :key="idx"
                         :draggable="!qrManageMode"
                         @dragstart="onQRDragStart($event, qr)"
                         @click="qrManageMode && toggleQRSelection(idx, $event)"
                         :class="['group px-3 py-2.5 bg-white border rounded-xl transition-all relative', 
                                  qrManageMode ? 'cursor-pointer' : 'cursor-move',
                                  selectedQRIds.includes(idx) ? 'border-purple-500 bg-purple-50 ring-2 ring-purple-200' : 'border-purple-100 hover:border-purple-300 hover:shadow-md']">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <i v-if="!qrManageMode" data-lucide="grip-vertical" class="w-3.5 h-3.5 text-purple-300 group-hover:text-purple-500 transition flex-shrink-0"></i>
                                <div v-else class="flex items-center justify-center w-4 h-4 rounded border-2 flex-shrink-0"
                                     :class="selectedQRIds.includes(idx) ? 'bg-purple-500 border-purple-500' : 'border-gray-300'">
                                    <i v-if="selectedQRIds.includes(idx)" data-lucide="check" class="w-3 h-3 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] font-bold text-gray-700 truncate">{{qr.name}}</div>
                                    <div class="text-[9px] text-gray-400 font-mono truncate">{{qr.fileName}}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <span class="text-[9px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded-full font-bold">
                                    {{(qr.data?.qrList || qr.data?.quickReplySlots || []).length}}
                                </span>
                                <button v-if="!qrManageMode" @click.stop="removeQRFromList(idx)" class="opacity-0 group-hover:opacity-100 p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡åˆ é™¤æŒ‰é’® -->
                    <div v-if="qrManageMode && selectedQRIds.length > 0" class="flex items-center gap-2 p-2 bg-purple-50 rounded-lg border border-purple-200">
                        <span class="text-[10px] font-bold text-purple-700 flex-1">å·²é€‰ä¸­ {{selectedQRIds.length}} ä¸ª</span>
                        <button @click="batchDeleteQR" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-[10px] font-bold hover:bg-red-600 transition flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> åˆ é™¤é€‰ä¸­
                        </button>
                    </div>
                    
                    <!-- æ‰‹åŠ¨å¯¼å…¥ QR æŒ‰é’® -->
                    <label class="flex items-center justify-center gap-2 px-3 py-2 bg-purple-500 text-white rounded-lg text-[10px] font-bold cursor-pointer hover:bg-purple-600 transition-all shadow-sm">
                        <i data-lucide="plus" class="w-3 h-3"></i> å¯¼å…¥ QR
                        <input type="file" multiple accept=".json" class="hidden" @change="handleQRImport">
                    </label>
                </div>
            </div>
        </nav>

        <div class="p-4 bg-gray-50 border-t border-gray-100 space-y-2">
            <label class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-900 text-white rounded-xl font-bold text-xs cursor-pointer hover:bg-black transition-all shadow-lg shadow-gray-200">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> å¯¼å…¥æ–‡ä»¶
                <input type="file" multiple accept=".png,.json" class="hidden" @change="handleImport">
            </label>
            <label class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-xl font-bold text-[11px] cursor-pointer hover:bg-blue-700 transition-all shadow-md">
                <i data-lucide="folder-open" class="w-3.5 h-3.5"></i> å¯¼å…¥æ–‡ä»¶å¤¹
                <input type="file" multiple webkitdirectory directory class="hidden" @change="handleFolderImport">
            </label>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-[#F8FAFC] relative">
        <header class="h-16 bg-white border-b border-gray-200 px-6 flex items-center justify-between shrink-0 z-10">
            <div class="flex items-center gap-4 flex-1">
                <div class="relative w-72">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input v-model="search" type="text" placeholder="æœç´¢åç§°ã€æ–‡ä»¶å..." class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-xl border-none focus:ring-2 focus:ring-rose-500/20 text-xs font-medium">
                </div>
                <select v-model="sortBy" class="bg-white border border-gray-200 rounded-xl px-3 py-1.5 text-xs font-bold text-gray-600 outline-none">
                    <option value="time-desc">æœ€æ–°æ—¶é—´</option>
                    <option value="time-asc">æœ€æ—§æ—¶é—´</option>
                    <option value="name-asc">åç§° A-Z</option>
                    <option value="name-desc">åç§° Z-A</option>
                </select>
            </div>

            <div class="flex items-center gap-3">
                <template v-if="isEditMode">
                    <button @click="selectAll" class="text-xs font-bold text-gray-500 hover:text-rose-600">å…¨é€‰</button>
                    <button @click="selectedIds = []" class="text-xs font-bold text-gray-400">æ¸…ç©º</button>
                    <div class="h-4 w-px bg-gray-200 mx-2"></div>
                    <button v-if="selectedIds.length === 2" @click="showDiff = true" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-black transition flex items-center gap-2">
                        <i data-lucide="scale" class="w-3.5 h-3.5"></i> è¯¦ç»†å¯¹æ¯”
                    </button>
                    <button @click="isEditMode = false; selectedIds = []" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold hover:bg-gray-50 transition shadow-sm">é€€å‡ºç¼–è¾‘æ¨¡å¼</button>
                </template>
                <button v-else @click="isEditMode = true" class="px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-bold shadow-sm hover:shadow-md transition-all duration-200">ç®¡ç† / æ“ä½œæ¨¡å¼</button>
            </div>
        </header>

        <!-- åŠ è½½ä¸­é®ç½© -->
        <div v-if="isLoading" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="w-10 h-10 border-4 border-rose-200 border-t-rose-500 rounded-full animate-spin mb-4"></div>
            <div class="text-gray-500 font-bold text-sm">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>

        <!-- ä¸»è§†å›¾åŒºåŸŸ -->
        <div class="flex-1 overflow-y-auto p-6 custom-scrollbar" @click.self="selectedIds = []">
            <template v-if="viewMode === 'duplicates'">
                <div v-for="groupObj in paginatedGroups" :key="groupObj.name" class="mb-8">
                    <div class="flex items-center gap-3 mb-3 px-1">
                        <div class="w-1.5 h-4 bg-rose-500 rounded-full"></div>
                        <h3 class="font-black text-gray-800 text-sm">{{groupObj.name}}</h3>
                        <span class="px-2 py-0.5 bg-rose-100 text-rose-600 text-[10px] font-bold rounded-full">{{groupObj.list.length}} å¼ </span>
                    </div>
                    <div class="border-2 border-rose-200 bg-white/50 rounded-2xl p-4 flex gap-4 overflow-x-auto custom-scrollbar">
                        <div v-for="card in groupObj.list" :key="card.id" 
                            @click="handleCardClick(card.id, null)"
                            draggable="true"
                            @dragstart="onDragStart($event, card)"
                            @drop="onQRDrop($event, card)"
                            @dragover.prevent
                            @dragenter="onQRDragEnter($event, card)"
                            @dragleave="onQRDragLeave"
                            class="w-40 shrink-0"
                            :class="['group bg-white rounded-xl border transition-all duration-300 cursor-pointer relative overflow-hidden shadow-sm hover:shadow-md', 
                                     selectedIds.includes(card.id) ? 'bg-gray-900/10 backdrop-blur-sm border-rose-500 ring-2 ring-rose-300/50' : 'border-gray-200',
                                     pendingQRBind && pendingQRBind.cardId === card.id ? 'ring-4 ring-purple-400/50 bg-purple-50/50' : '']">
                            
                            <!-- QR å¾…ç»‘å®šç¡®è®¤æŒ‰é’® -->
                            <div v-if="pendingQRBind && pendingQRBind.cardId === card.id" 
                                 class="absolute inset-0 bg-purple-600/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center gap-2 p-3 animate-in fade-in zoom-in-95">
                                <div class="text-white text-center">
                                    <i data-lucide="zap" class="w-6 h-6 mx-auto mb-1 animate-pulse"></i>
                                    <p class="text-[10px] font-bold mb-1">ç¡®è®¤ç»‘å®šï¼Ÿ</p>
                                    <p class="text-[8px] opacity-80 font-mono truncate max-w-full px-2">{{pendingQRBind.qrFileName}}</p>
                                </div>
                                <div class="flex gap-1">
                                    <button @click.stop="confirmQRBind" class="px-3 py-1.5 bg-white text-purple-600 rounded-lg text-[10px] font-bold hover:bg-purple-50 transition shadow-lg">
                                        <i data-lucide="check" class="w-2.5 h-2.5 inline mr-0.5"></i>ç¡®è®¤
                                    </button>
                                    <button @click.stop="cancelQRBind" class="px-3 py-1.5 bg-purple-700 text-white rounded-lg text-[10px] font-bold hover:bg-purple-800 transition">
                                        <i data-lucide="x" class="w-2.5 h-2.5 inline mr-0.5"></i>å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                            
                            <div class="aspect-[2/3] bg-gray-50 relative overflow-hidden">
                                <img v-if="card.imgUrl" :src="card.imgUrl" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                <div v-if="card.hasLore" class="absolute bottom-1 right-1 bg-black/60 backdrop-blur-md text-[8px] text-amber-400 px-1.5 py-0.5 rounded-full border border-amber-500/30 font-bold">WI</div>
                                <!-- QR ç»‘å®šæ ‡è¯† -->
                                <div v-if="card.quickReplies" class="absolute top-1 right-1 bg-purple-500/90 backdrop-blur-md text-[8px] text-white px-1.5 py-0.5 rounded-full border border-purple-300 font-bold flex items-center gap-0.5 shadow-lg">
                                     <i data-lucide="zap" class="w-2 h-2"></i> QR
                                </div>
                            </div>
                            <div class="p-2">
                                <div class="text-[11px] text-gray-400 truncate mb-0.5 font-mono">{{card.fileName}}</div>
                                <div class="mt-1.5 px-1.5 py-1 bg-gray-50 rounded border border-gray-100">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <div class="text-[8px] text-gray-400 font-bold uppercase">First Message</div>
                                        <div class="flex items-center gap-0.5 bg-white px-1 py-0.5 rounded-full border border-gray-100 shadow-sm">
                                            <i data-lucide="message-circle" class="w-2 h-2 text-rose-400 fill-rose-50"></i>
                                            <span class="text-[8px] font-bold text-rose-500 leading-none">{{1 + (card.data.alternate_greetings || []).length}}</span>
                                        </div>
                                    </div>
                                    <div class="text-[10px] text-gray-600 line-clamp-3 font-mono leading-tight">{{card.data.first_mes || 'No greetings...'}}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="duplicateGroupsList.length > 0" class="mt-6 pt-4 border-t border-gray-100 flex flex-wrap items-center justify-between gap-4 sticky bottom-0 bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm z-10">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-gray-500">æ¯é¡µæ˜¾ç¤º</span>
                        <select v-model="itemsPerPage" class="bg-white border border-gray-200 rounded-xl text-xs font-bold py-2 px-3 outline-none focus:ring-2 focus:ring-rose-500/20 cursor-pointer shadow-sm hover:border-gray-300 transition-colors">
                            <option :value="10">10</option>
                            <option :value="20">20</option>
                            <option :value="30">30</option>
                            <option :value="50">50</option>
                            <option :value="100">100</option>
                            <option :value="500">500</option>
                            <option :value="1000">1000</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-xl border border-gray-100">
                        <button @click="setPage(currentPage - 1)" :disabled="currentPage === 1" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed text-gray-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span class="text-xs font-black text-gray-600 font-mono px-3 min-w-[100px] text-center">{{currentPage}} / {{totalPages}}</span>
                        <button @click="setPage(currentPage + 1)" :disabled="currentPage === totalPages" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-400">è·³è½¬è‡³</span>
                        <input type="number" v-model="pageJumpInput" @keyup.enter="setPage(pageJumpInput)" class="w-16 bg-white border border-gray-200 rounded-xl text-xs font-bold py-2 px-2 text-center outline-none focus:ring-2 focus:ring-rose-500/20 shadow-sm" min="1" :max="totalPages">
                        <button @click="setPage(pageJumpInput)" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-black transition shadow-lg shadow-gray-200">Go</button>
                    </div>
                </div>

                <div v-if="duplicateGroupsList.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400 pb-20">
                    <i data-lucide="check-circle-2" class="w-12 h-12 mb-4 text-gray-300"></i>
                    <p class="font-bold">æ²¡æœ‰å‘ç°åç§°é‡å¤çš„æ¡£æ¡ˆ</p>
                </div>
            </template>
            <template v-else>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-5">
                    <div v-for="card in paginatedCards" :key="card.id" 
                        @click="handleCardClick(card.id, $event)"
                        draggable="true"
                        @dragstart="onDragStart($event, card)"
                        @drop="onQRDrop($event, card)"
                        @dragover.prevent
                        @dragenter="onQRDragEnter($event, card)"
                        @dragleave="onQRDragLeave"
                        :class="['group bg-white rounded-2xl border border-gray-200 transition-all duration-300 cursor-pointer relative overflow-hidden card-shadow', 
                                 selectedIds.includes(card.id) ? 'bg-gray-900/10 backdrop-blur-sm border-rose-500 ring-2 ring-rose-300/50 shadow-rose-100' : '',
                                 pendingQRBind && pendingQRBind.cardId === card.id ? 'ring-4 ring-purple-400/50 bg-purple-50/50' : '']">
                        
                        <!-- QR å¾…ç»‘å®šç¡®è®¤æŒ‰é’® -->
                        <div v-if="pendingQRBind && pendingQRBind.cardId === card.id" 
                             class="absolute inset-0 bg-purple-600/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center gap-3 p-4 animate-in fade-in zoom-in-95">
                            <div class="text-white text-center">
                                <i data-lucide="zap" class="w-8 h-8 mx-auto mb-2 animate-pulse"></i>
                                <p class="text-xs font-bold mb-1">ç¡®è®¤ç»‘å®š QRï¼Ÿ</p>
                                <p class="text-[10px] opacity-80 font-mono truncate max-w-full px-2">{{pendingQRBind.qrFileName}}</p>
                            </div>
                            <div class="flex gap-2">
                                <button @click.stop="confirmQRBind" class="px-4 py-2 bg-white text-purple-600 rounded-lg text-xs font-bold hover:bg-purple-50 transition shadow-lg">
                                    <i data-lucide="check" class="w-3 h-3 inline mr-1"></i>
                                    ç¡®è®¤
                                </button>
                                <button @click.stop="cancelQRBind" class="px-4 py-2 bg-purple-700 text-white rounded-lg text-xs font-bold hover:bg-purple-800 transition">
                                    <i data-lucide="x" class="w-3 h-3 inline mr-1"></i>
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                        
                        <div class="aspect-[2/3] bg-gray-50 relative overflow-hidden">
                            <img v-if="card.imgUrl" :src="card.imgUrl" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                            <div v-if="card.hasLore" class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-md text-[9px] text-amber-400 px-2 py-0.5 rounded-full border border-amber-500/30 font-bold flex items-center gap-1">
                                 <i data-lucide="book" class="w-2.5 h-2.5"></i> WORLD INFO
                            </div>
                            <!-- QR ç»‘å®šæ ‡è¯† -->
                            <div v-if="card.quickReplies" class="absolute top-2 right-2 bg-purple-500/90 backdrop-blur-md text-[9px] text-white px-2 py-0.5 rounded-full border border-purple-300 font-bold flex items-center gap-1 shadow-lg">
                                 <i data-lucide="zap" class="w-2.5 h-2.5"></i> QR
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="flex items-center gap-1.5">
                                <div class="font-black text-[13px] truncate text-gray-800">{{card.data.name}}</div>
                                <span v-if="card.data.extensions?.chub?.version" class="text-[10px] text-gray-400 font-medium shrink-0">v{{card.data.extensions.chub.version}}</span>
                            </div>
                            <div class="text-[11px] text-gray-400 truncate mt-1 flex items-center gap-1 font-mono">
                                <i data-lucide="file" class="w-2.5 h-2.5"></i> {{card.fileName}}
                            </div>
                            <div class="mt-2 px-2 py-1.5 bg-gray-50 rounded-lg border border-gray-100">
                                <div class="flex justify-between items-center mb-0.5">
                                    <div class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">First Message</div>
                                    <div class="flex items-center gap-1 bg-white px-1.5 py-0.5 rounded-full border border-gray-100 shadow-sm">
                                        <i data-lucide="message-circle" class="w-2.5 h-2.5 text-rose-400 fill-rose-50"></i>
                                        <span class="text-[9px] font-bold text-rose-500 leading-none">{{1 + (card.data.alternate_greetings || []).length}}</span>
                                    </div>
                                </div>
                                <div class="text-[11px] text-gray-600 line-clamp-3 font-mono leading-tight">{{card.data.first_mes || 'No greetings...'}}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="filteredCards.length > 0" class="col-span-full mt-6 pt-4 border-t border-gray-100 flex flex-wrap items-center justify-between gap-4 sticky bottom-0 bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-sm z-10">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-gray-500">æ¯é¡µæ˜¾ç¤º</span>
                            <select v-model="itemsPerPage" class="bg-white border border-gray-200 rounded-xl text-xs font-bold py-2 px-3 outline-none focus:ring-2 focus:ring-rose-500/20 cursor-pointer shadow-sm hover:border-gray-300 transition-colors">
                                <option :value="10">10</option>
                                <option :value="20">20</option>
                                <option :value="30">30</option>
                                <option :value="50">50</option>
                                <option :value="100">100</option>
                                <option :value="500">500</option>
                                <option :value="1000">1000</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-50 p-1 rounded-xl border border-gray-100">
                            <button @click="setPage(currentPage - 1)" :disabled="currentPage === 1" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed text-gray-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <span class="text-xs font-black text-gray-600 font-mono px-3 min-w-[100px] text-center">{{currentPage}} / {{totalPages}}</span>
                            <button @click="setPage(currentPage + 1)" :disabled="currentPage === totalPages" class="p-2 hover:bg-white hover:shadow-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-400">è·³è½¬è‡³</span>
                            <input type="number" v-model="pageJumpInput" @keyup.enter="setPage(pageJumpInput)" class="w-16 bg-white border border-gray-200 rounded-xl text-xs font-bold py-2 px-2 text-center outline-none focus:ring-2 focus:ring-rose-500/20 shadow-sm" min="1" :max="totalPages">
                            <button @click="setPage(pageJumpInput)" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-black transition shadow-lg shadow-gray-200">Go</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- åº•éƒ¨æ‰¹é‡æ“ä½œæ  -->
        <div v-if="isEditMode && selectedIds.length > 0" class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl px-8 py-5 rounded-3xl shadow-2xl border border-white/50 flex items-center gap-8 z-30 ring-1 ring-black/5 animate-in slide-in-from-bottom-4">
            <div class="text-xs font-black border-r border-gray-200 pr-8">å·²é€‰ä¸­ {{selectedIds.length}} ä¸ªæ¡£æ¡ˆ</div>
            <div class="flex items-center gap-4">
                <button @click="batchDelete" class="text-red-500 font-bold text-xs flex items-center gap-2 hover:bg-red-50 px-3 py-2 rounded-xl transition"><i data-lucide="trash-2" class="w-4 h-4"></i> æ‰¹é‡åˆ é™¤</button>
                <button @click="showBatchModal = true" class="text-slate-700 font-bold text-xs flex items-center gap-2 hover:bg-slate-50 px-3 py-2 rounded-xl transition"><i data-lucide="edit-3" class="w-4 h-4"></i> æ‰¹é‡ä¿®æ”¹</button>
                <button @click="batchExport" class="text-rose-500 font-bold text-xs flex items-center gap-2 hover:bg-rose-50 px-3 py-2 rounded-xl transition"><i data-lucide="package" class="w-4 h-4"></i> æ‰“åŒ…é€‰ä¸­ (ZIP)</button>
                <button v-if="selectedFolderForExport" @click="exportFolder(selectedFolderForExport)" class="text-purple-600 font-bold text-xs flex items-center gap-2 hover:bg-purple-50 px-3 py-2 rounded-xl transition border border-purple-300 bg-purple-50"><i data-lucide="folder-archive" class="w-4 h-4"></i> å¯¼å‡ºã€Œ{{selectedFolderForExport}}ã€</button>
                <button @click="batchExportAll" class="text-purple-500 font-bold text-xs flex items-center gap-2 hover:bg-purple-50 px-3 py-2 rounded-xl transition"><i data-lucide="archive" class="w-4 h-4"></i> æ‰“åŒ…å…¨éƒ¨ (ZIP)</button>
            </div>
        </div>
    </main>

    <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
    <transition name="slide">
        <aside v-if="activeCard && !isEditMode" class="fixed inset-y-0 right-0 w-[550px] bg-white shadow-[-20px_0_50px_rgba(0,0,0,0.1)] z-40 flex flex-col">
            <div class="h-16 border-b flex items-center justify-between px-6 shrink-0 bg-white/50 backdrop-blur-md sticky top-0 z-10">
                <span class="font-black text-gray-800 italic tracking-tight">æ¡£æ¡ˆè¯¦æƒ…ä¸ä¿®æ”¹</span>
                <div class="flex items-center gap-2">
                    <button @click="selectedIds = []" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 space-y-8 custom-scrollbar">
                <div class="flex gap-6">
                    <div class="w-28 h-28 rounded-2xl border-4 border-white shadow-xl bg-gray-50 shrink-0 overflow-hidden relative group">
                        <img :src="activeCard.imgUrl" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity cursor-pointer">
                            <i data-lucide="camera" class="text-white w-6 h-6"></i>
                        </div>
                        <input type="file" accept="image/*" @change="updateAvatar" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <div class="flex-1 space-y-3">
                        <input v-model="activeCard.data.name" class="w-full font-black text-2xl border-none p-0 focus:ring-0 text-gray-800" placeholder="è§’è‰²åç§°">
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-xl border border-gray-100 transition-all focus-within:bg-white focus-within:ring-2 focus-within:ring-rose-500/10">
                                <i data-lucide="file-text" class="w-4 h-4 text-gray-400"></i>
                                <input v-model="activeCard.fileName" class="w-full bg-transparent text-xs text-gray-600 font-mono border-none p-0 focus:ring-0 font-semibold" placeholder="filename.png">
                            </div>
                            <div class="text-xs text-gray-500 font-mono pl-1 flex items-center gap-2 py-1">
                                <i data-lucide="calendar" class="w-4 h-4"></i> 
                                <span class="font-semibold">å¯¼å…¥äº:</span> 
                                <span class="text-gray-700">{{ new Date(activeCard.importDate).toLocaleString() }}</span>
                            </div>
                            <div v-if="activeCard.fileLastModified" class="text-xs text-orange-600 font-mono pl-1 flex items-center gap-2 py-1">
                                <i data-lucide="file-clock" class="w-4 h-4"></i> 
                                <span class="font-bold">æ–‡ä»¶ä¿®æ”¹:</span> 
                                <span class="font-semibold">{{ formatDate(activeCard.fileLastModified) }}</span>
                            </div>
                            <div v-if="activeCard.lastModified" class="text-xs text-blue-600 font-mono pl-1 flex items-center gap-2 py-1">
                                <i data-lucide="clock" class="w-4 h-4"></i> 
                                <span class="font-bold">æœ€è¿‘ç¼–è¾‘:</span> 
                                <span class="font-semibold">{{ formatDate(activeCard.lastModified) }}</span>
                            </div>
                            <!-- å¤åˆ¶åˆ é™¤æŒ‰é’®æ”¾åœ¨æ—¶é—´ä¿¡æ¯ä¸‹æ–¹ -->
                            <div class="flex items-center gap-2 pt-2">
                                <button @click="duplicateCard(activeCard.id)" class="flex-1 px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition flex items-center justify-center gap-1.5" title="å¤åˆ¶æ­¤å¡ç‰‡">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                    <span>å¤åˆ¶</span>
                                </button>
                                <button @click="deleteCardWithConfirm(activeCard.id)" class="flex-1 px-3 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition flex items-center justify-center gap-1.5" title="åˆ é™¤æ­¤å¡ç‰‡">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    <span>åˆ é™¤</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ ‡ç­¾/æ–‡ä»¶å¤¹ (å›è½¦æ·»åŠ )</label>
                        <div class="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                            <span v-for="(t, i) in activeCard.data.tags" :key="i" class="bg-white border border-gray-200 px-3 py-1 rounded-xl text-[11px] font-bold flex items-center gap-2 shadow-sm text-gray-600">
                                <i v-if="customFolders.includes(t)" data-lucide="folder" class="w-3 h-3 text-blue-400"></i>
                                {{t}} 
                                <i data-lucide="x" class="w-3 h-3 cursor-pointer text-gray-300 hover:text-rose-500" @click="activeCard.data.tags.splice(i,1)"></i>
                            </span>
                            <input @keyup.enter="addTag" placeholder="+ æ ‡ç­¾/æ–‡ä»¶å¤¹" class="bg-transparent outline-none text-[11px] w-24">
                        </div>
                    </div>

                    <!-- å¤‡æ³¨æ  (åŸå¸–é“¾æ¥) -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="link" class="w-3.5 h-3.5"></i> å¤‡æ³¨ / åŸå¸–é“¾æ¥
                        </label>
                        <div class="flex items-center gap-2">
                            <input v-model="activeCard.note" @input="saveCardToDB(activeCard)" placeholder="è¾“å…¥å¤‡æ³¨æˆ–åŸå¸–é“¾æ¥ (å¦‚DiscordåŸå¸–)" class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-xs focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
                            <a v-if="activeCard?.note && isValidUrl(activeCard.note)" :href="activeCard.note" target="_blank" class="px-4 py-2.5 bg-blue-500 text-white rounded-xl text-xs font-bold hover:bg-blue-600 transition shadow-sm flex items-center gap-1.5 shrink-0">
                                <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                                è®¿é—®
                            </a>
                        </div>
                        <div v-if="activeCard?.note" class="px-3 py-2 bg-blue-50 border border-blue-100 rounded-lg text-[11px] text-gray-600 break-all">
                            {{activeCard.note}}
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿå›å¤æŒ‰é’® (SillyTavern Quick Replies) -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="zap" class="w-3.5 h-3.5"></i> å¿«é€Ÿå›å¤æŒ‰é’® (Quick Replies)
                        </label>
                        <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-dashed border-purple-200 rounded-xl">
                            <div v-if="!activeCard.quickReplies" class="text-center py-6">
                                <i data-lucide="upload" class="w-8 h-8 mx-auto mb-2 text-purple-300"></i>
                                <p class="text-xs text-gray-500 mb-3">æœªå¯¼å…¥å¿«é€Ÿå›å¤é…ç½®</p>
                                <label class="inline-flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg text-xs font-bold cursor-pointer hover:bg-purple-600 transition shadow-sm">
                                    <i data-lucide="file-plus" class="w-3.5 h-3.5"></i> å¯¼å…¥ JSON
                                    <input type="file" accept=".json" class="hidden" @change="importQuickReplies">
                                </label>
                            </div>
                            <div v-else class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <span class="text-xs font-bold text-gray-700">å·²å¯¼å…¥å¿«é€Ÿå›å¤é…ç½®</span>
                                    </div>
                                    <button @click="removeQuickReplies" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <div class="bg-white rounded-lg p-3 border border-purple-200">
                                    <div class="text-[10px] text-gray-500 mb-2 font-mono">
                                        æ–‡ä»¶å: {{ activeCard.quickReplies.fileName || 'quickReplies.json' }}
                                    </div>
                                    <div class="flex flex-wrap gap-1.5">
                                        <span v-for="(btn, idx) in (activeCard.quickReplies.data?.quickReplySlots || []).slice(0, 5)" :key="idx" 
                                              class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-[10px] font-medium border border-purple-200">
                                            {{ btn.label || 'æŒ‰é’® ' + (idx + 1) }}
                                        </span>
                                        <span v-if="(activeCard.quickReplies.data?.quickReplySlots || []).length > 5" class="px-2 py-1 bg-gray-100 text-gray-500 rounded text-[10px]">
                                            +{{ (activeCard.quickReplies.data?.quickReplySlots || []).length - 5 }} æ›´å¤š
                                        </span>
                                    </div>
                                </div>
                                <button @click="downloadQuickReplies" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg text-xs font-bold hover:bg-purple-600 transition shadow-sm">
                                    <i data-lucide="download" class="w-3.5 h-3.5"></i> ä¸‹è½½ JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Features Buttons -->
                    <div class="flex gap-3">
                        <button @click="openWorldInfo" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-amber-50 text-amber-600 rounded-xl font-bold border border-amber-100 hover:bg-amber-100 transition-colors text-xs">
                            <i data-lucide="book" class="w-4 h-4"></i> ä¸–ç•Œä¹¦ ({{ (activeCard.data.character_book?.entries || []).length }})
                        </button>
                        <button @click="openRegex" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold border border-indigo-100 hover:bg-indigo-100 transition-colors text-xs">
                            <i data-lucide="code" class="w-4 h-4"></i> æ­£åˆ™è„šæœ¬ ({{ (activeCard.data.extensions?.regex_scripts || activeCard.data.regex_scripts || []).length }})
                        </button>
                    </div>

                    <!-- è§’è‰²çŠ¶æ€ä¿¡æ¯å±•ç¤º -->
                    <div v-if="activeCard.data.creator_notes || activeCard.data.system_prompt || activeCard.data.post_history_instructions || activeCard.data.scenario || activeCard.data.personality || activeCard.data.mes_example" class="space-y-3 p-5 bg-gradient-to-br from-slate-50 to-gray-50 rounded-2xl border border-gray-200">
                        <div class="flex items-center gap-2 text-sm font-black text-gray-700 pb-2 border-b border-gray-200">
                            <i data-lucide="info" class="w-4 h-4 text-blue-500"></i>
                            è§’è‰²è¯¦ç»†ä¿¡æ¯
                        </div>
                        
                        <!-- Creator Notes / ä½œè€…å¤‡æ³¨ -->
                        <div v-if="activeCard.data.creator_notes || activeCard.data.extensions?.chub?.version" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="user-pen" class="w-3 h-3"></i> ä½œè€…å¤‡æ³¨
                                <span v-if="activeCard.data.extensions?.chub?.version" class="text-[10px] text-gray-400 font-medium normal-case ml-1">v{{activeCard.data.extensions.chub.version}}</span>
                            </div>
                            <div v-if="activeCard.data.creator_notes" class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 whitespace-pre-wrap">{{activeCard.data.creator_notes}}</div>
                            <div v-else class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-400 border border-gray-100 italic">æš‚æ— ä½œè€…å¤‡æ³¨</div>
                        </div>

                        <!-- Personality / æ€§æ ¼ -->
                        <div v-if="activeCard.data.personality" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="smile" class="w-3 h-3"></i> æ€§æ ¼ç‰¹å¾
                            </div>
                            <div class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 whitespace-pre-wrap">{{activeCard.data.personality}}</div>
                        </div>

                        <!-- Scenario / åœºæ™¯è®¾å®š -->
                        <div v-if="activeCard.data.scenario" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="map" class="w-3 h-3"></i> åœºæ™¯è®¾å®š
                            </div>
                            <div class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 whitespace-pre-wrap">{{activeCard.data.scenario}}</div>
                        </div>

                        <!-- Message Examples / å¯¹è¯ç¤ºä¾‹ -->
                        <div v-if="activeCard.data.mes_example" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="message-square-quote" class="w-3 h-3"></i> å¯¹è¯ç¤ºä¾‹
                            </div>
                            <div class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 font-mono whitespace-pre-wrap">{{activeCard.data.mes_example}}</div>
                        </div>

                        <!-- System Prompt / ç³»ç»Ÿæç¤ºè¯ -->
                        <div v-if="activeCard.data.system_prompt" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="terminal" class="w-3 h-3"></i> ç³»ç»Ÿæç¤ºè¯
                            </div>
                            <div class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 font-mono whitespace-pre-wrap">{{activeCard.data.system_prompt}}</div>
                        </div>

                        <!-- Post History Instructions / å†å²è®°å½•æŒ‡ä»¤ -->
                        <div v-if="activeCard.data.post_history_instructions" class="space-y-1.5">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-1.5">
                                <i data-lucide="scroll-text" class="w-3 h-3"></i> å†å²è®°å½•æŒ‡ä»¤
                            </div>
                            <div class="bg-white rounded-xl p-4 text-xs leading-relaxed text-gray-700 border border-gray-100 font-mono whitespace-pre-wrap">{{activeCard.data.post_history_instructions}}</div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                            <i data-lucide="quote" class="w-3 h-3 text-rose-400"></i> æè¿° (Description)
                        </label>
                        <textarea v-model="activeCard.data.description" rows="12" class="w-full bg-gray-50 border-none rounded-2xl p-5 text-xs leading-relaxed font-mono focus:ring-2 focus:ring-rose-500/10 transition-all"></textarea>
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-3 h-3 text-rose-400"></i> å¼€åœºç™½ (First Message)
                            </label>
                            <button @click="showFirstMesModal = true; viewingAltIndex = -1" class="text-[10px] flex items-center gap-1 text-blue-500 hover:text-blue-700 font-bold bg-blue-50 px-2 py-1 rounded-lg">
                                <i data-lucide="maximize-2" class="w-3 h-3"></i> å…¨å±æŸ¥çœ‹ / ç¼–è¾‘
                            </button>
                        </div>
                        <textarea v-model="activeCard.data.first_mes" rows="6" class="w-full bg-gray-50 border-none rounded-2xl p-5 text-xs leading-relaxed font-mono focus:ring-2 focus:ring-rose-500/10"></textarea>
                    </div>

                    <div class="space-y-2 pt-2 border-t border-dashed border-gray-200 mt-4">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="layers" class="w-3 h-3 text-rose-400"></i> å¤‡é€‰å¼€åœºç™½ ({{(activeCard.data.alternate_greetings || []).length}})
                            </label>
                            <button @click="addAlternate" class="text-[10px] flex items-center gap-1 text-rose-500 hover:text-rose-700 font-bold bg-rose-50 px-2 py-1 rounded-lg">
                                <i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ 
                            </button>
                        </div>
                        <div v-if="activeCard.data.alternate_greetings && activeCard.data.alternate_greetings.length > 0" class="space-y-3">
                            <div v-for="(alt, idx) in activeCard.data.alternate_greetings" :key="idx" class="relative group">
                                <textarea v-model="activeCard.data.alternate_greetings[idx]" rows="3" class="w-full bg-gray-50 border-none rounded-xl p-3 text-xs leading-relaxed font-mono focus:ring-2 focus:ring-rose-500/10 pr-8 transition-colors hover:bg-white border border-transparent hover:border-gray-200"></textarea>
                                <button @click="removeAlternate(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 rounded p-0.5 backdrop-blur-sm">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                                <div class="absolute bottom-2 right-2 text-[9px] text-gray-300 pointer-events-none select-none">#{{idx + 1}}</div>
                            </div>
                        </div>
                        <div v-else class="text-xs text-gray-400 italic text-center py-4 bg-gray-50 rounded-xl border border-dashed border-gray-200">æš‚æ— å¤‡é€‰å¼€åœºç™½</div>
                    </div>
                </div>
            </div>
            
            <div class="p-8 border-t border-gray-100 bg-white sticky bottom-0 space-y-3">
                <div class="flex gap-3">
                    <button @click="exportSingle(activeCard)" class="flex-1 py-4 bg-rose-500 text-white rounded-2xl font-black shadow-xl shadow-rose-200 hover:bg-rose-600 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="save"></i> å†™å…¥å¹¶å¯¼å‡º PNG
                    </button>
                    <button @click="exportJson(activeCard)" class="w-14 py-4 bg-slate-100 text-slate-500 rounded-2xl flex items-center justify-center hover:bg-slate-200 transition-all">
                        <i data-lucide="file-json"></i>
                    </button>
                </div>
                <div class="flex gap-3">
                    <button @click="exportFolderOrSingle(false)" class="flex-1 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-all flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="package" class="w-4 h-4"></i> æ‰“åŒ…å•å¡ (ZIP)
                    </button>
                </div>
            </div>
        </aside>
    </transition>

    <!-- å…¨å±å¼€åœºç™½æŸ¥çœ‹å™¨ + é¢„è§ˆåŠŸèƒ½ -->
    <div v-if="showFirstMesModal && activeCard" class="fixed inset-0 z-[100] bg-white/90 backdrop-blur-md flex items-center justify-center p-8">
        <div class="bg-white w-full max-w-5xl h-[85vh] shadow-2xl rounded-3xl flex flex-col border border-gray-100 animate-in zoom-in-95 duration-200">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-slate-50 rounded-t-3xl">
                <div class="flex items-center gap-4">
                    <span class="font-black text-lg text-gray-800 flex items-center gap-2">
                        <i data-lucide="edit-3" class="text-rose-500"></i>
                        {{ viewingAltIndex === -1 ? 'ä¸»å¼€åœºç™½ (Main)' : `å¤‡é€‰å¼€åœºç™½ #${viewingAltIndex + 1}` }}
                    </span>
                    <!-- æ¨¡å¼åˆ‡æ¢ -->
                    <div class="flex bg-gray-200 p-1 rounded-lg">
                        <button @click="firstMesPreview = false" :class="['px-3 py-1 text-xs font-bold rounded-md transition', !firstMesPreview ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700']">ç¼–è¾‘ä»£ç </button>
                        <button @click="firstMesPreview = true" :class="['px-3 py-1 text-xs font-bold rounded-md transition', firstMesPreview ? 'bg-white shadow text-rose-600' : 'text-gray-500 hover:text-gray-700']">é¢„è§ˆæ•ˆæœ (HTML)</button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-gray-400">å­—æ•°: {{ (currentBigGreeting || '').length }}</span>
                    <button @click="showFirstMesModal = false" class="p-2 hover:bg-gray-100 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="flex-1 p-0 flex flex-col md:flex-row overflow-hidden relative">
                <!-- å·¦ä¾§ï¼šå¤§ç¼–è¾‘åŒº or é¢„è§ˆåŒº -->
                <div class="flex-1 border-r border-gray-100 flex flex-col bg-white overflow-hidden relative">
                    <textarea v-show="!firstMesPreview" v-model="currentBigGreeting" class="flex-1 w-full resize-none p-8 text-sm leading-7 text-gray-700 outline-none font-mono selection:bg-rose-100 custom-scrollbar" placeholder="æš‚æ— å†…å®¹..."></textarea>
                    
                    <!-- HTML é¢„è§ˆå®¹å™¨ -->
                    <div v-show="firstMesPreview" class="flex-1 w-full overflow-y-auto p-8 custom-scrollbar bg-slate-900">
                        <div class="st-preview-content text-gray-200 text-sm" v-html="currentBigGreeting"></div>
                        <div v-if="!currentBigGreeting" class="text-gray-600 italic">ç©ºå†…å®¹</div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå¯¼èˆªåˆ—è¡¨ -->
                <div class="w-80 md:w-80 bg-gray-50 flex flex-col border-t md:border-t-0 shrink-0">
                     <div class="px-4 py-3 border-b border-gray-200 text-[10px] font-bold text-gray-400 uppercase tracking-widest flex justify-between items-center">
                         <span>å¿«é€Ÿåˆ‡æ¢</span>
                         <button @click="addAlternate" class="text-rose-500 hover:bg-rose-100 p-1.5 rounded-lg transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                     </div>
                     <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                         <div @click="viewingAltIndex = -1"
                              :class="['group rounded-xl p-3 shadow-sm border relative cursor-pointer transition-all active:scale-[0.98]', viewingAltIndex === -1 ? 'bg-rose-50 border-rose-200 ring-2 ring-rose-100' : 'bg-white border-gray-100 hover:border-blue-300 hover:shadow-md']">
                             <div class="flex items-center justify-between mb-2">
                                 <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Main Message</div>
                                 <i v-if="viewingAltIndex === -1" data-lucide="eye" class="w-3.5 h-3.5 text-rose-500"></i>
                             </div>
                             <div class="text-xs leading-relaxed text-gray-600 font-mono line-clamp-3 pointer-events-none">{{ activeCard.data.first_mes || '(ç©º)' }}</div>
                         </div>
                         <div v-for="(alt, idx) in activeCard.data.alternate_greetings" :key="idx" 
                              @click="viewingAltIndex = idx"
                              :class="['group rounded-xl p-3 shadow-sm border relative cursor-pointer transition-all active:scale-[0.98]', viewingAltIndex === idx ? 'bg-blue-50 border-blue-200 ring-2 ring-blue-100' : 'bg-white border-gray-100 hover:border-blue-300 hover:shadow-md']">
                             <div class="flex items-center justify-between mb-2">
                                 <div class="text-[10px] font-bold text-gray-400">Alternate #{{idx + 1}}</div>
                                 <i v-if="viewingAltIndex === idx" data-lucide="eye" class="w-3.5 h-3.5 text-blue-500"></i>
                             </div>
                             <div class="text-xs leading-relaxed text-gray-600 font-mono line-clamp-3 pointer-events-none">{{ alt || '(ç©º)' }}</div>
                             <button @click.stop="removeAlternate(idx); if(viewingAltIndex===idx) viewingAltIndex=-1;" class="absolute top-2 right-2 p-1.5 opacity-0 group-hover:opacity-100 hover:bg-red-100 hover:text-red-500 rounded-lg transition-all">
                                 <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                             </button>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸–ç•Œä¹¦ç¼–è¾‘å™¨ - å®Œå…¨é‡åš ST é£æ ¼ -->
    <div v-if="wiModal.visible" class="fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[88vh] flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-rose-100 flex items-center justify-center">
                        <i data-lucide="book" class="w-5 h-5 text-rose-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">ä¸–ç•Œä¹¦ (World Info / Lorebook)</h3>
                        <p class="text-xs text-gray-500 font-medium">å…± {{wiModal.entries.length}} ä¸ªè¯æ¡</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="addWiEntry" class="px-4 py-2 bg-rose-500 text-white rounded-lg text-sm font-bold hover:bg-rose-600 transition flex items-center gap-2 shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> æ–°å»ºè¯æ¡
                    </button>
                    <button @click="wiModal.visible = false" class="p-2 hover:bg-gray-200 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden flex">
                <!-- å·¦ä¾§è¯æ¡åˆ—è¡¨ -->
                <div class="w-80 border-r border-gray-200 overflow-y-auto bg-gray-50 custom-scrollbar">
                    <div v-if="wiModal.entries.length === 0" class="p-12 text-center">
                        <i data-lucide="book-open" class="w-16 h-16 mx-auto mb-4 opacity-20 text-gray-400"></i>
                        <p class="text-sm font-semibold text-gray-500 mb-1">æš‚æ— ä¸–ç•Œä¹¦è¯æ¡</p>
                        <p class="text-xs text-gray-400">ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®åˆ›å»º</p>
                    </div>
                    
                    <div class="p-3 space-y-2">
                        <div v-for="(entry, idx) in wiModal.entries" :key="idx" 
                            @click="wiModal.selectedIndex = idx"
                            :class="['p-3 cursor-pointer transition-all rounded-lg border-2 bg-white', 
                                     wiModal.selectedIndex === idx 
                                     ? 'border-rose-400 shadow-md ring-2 ring-rose-100' 
                                     : 'border-gray-200 hover:border-gray-300 hover:shadow-sm']">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2 flex-1">
                                    <div class="w-2 h-2 rounded-full shrink-0" :class="entry.enabled !== false ? 'bg-green-500' : 'bg-gray-300'"></div>
                                    <span class="text-xs font-bold text-gray-500">#{{idx + 1}}</span>
                                </div>
                                <span class="text-[10px] font-mono text-gray-400 bg-gray-100 px-2 py-0.5 rounded">
                                    Order: {{entry.insertion_order || 100}}
                                </span>
                            </div>
                            <div class="text-sm font-bold text-gray-900 mb-1 truncate">
                                {{ (entry.keys || []).join(', ') || 'Unnamed Entry' }}
                            </div>
                            <div class="text-xs text-gray-500 line-clamp-2 leading-relaxed">
                                {{entry.content || '(ç©ºå†…å®¹)'}}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§è¯¦æƒ…åŒº -->
                <div v-if="wiModal.selectedIndex !== -1 && wiModal.entries[wiModal.selectedIndex]" class="flex-1 overflow-y-auto bg-white custom-scrollbar">
                    <div class="max-w-5xl mx-auto p-6">
                        <!-- æ“ä½œæŒ‰é’®æ  -->
                        <div class="flex justify-between items-center mb-5 pb-4 border-b border-gray-200">
                            <h4 class="font-black text-lg text-gray-900">è¯æ¡è¯¦æƒ…</h4>
                            <button @click="deleteWiEntry(wiModal.selectedIndex)" 
                                    class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> åˆ é™¤
                            </button>
                        </div>
                        
                        <!-- è¡¨å•åŒºåŸŸ -->
                        <div class="space-y-5">
                            <!-- è§¦å‘å…³é”®è¯å’ŒçŠ¶æ€ -->
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="key" class="w-3.5 h-3.5 text-blue-500"></i>
                                        è§¦å‘å…³é”®è¯ (Keys) - ç”¨é€—å·åˆ†éš”
                                    </label>
                                    <input v-model="wiModal.entries[wiModal.selectedIndex].keysInput" 
                                           @change="updateWiKeys(wiModal.selectedIndex)"
                                           class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400/30 focus:border-blue-400 text-sm font-semibold transition"
                                           placeholder="ä¾‹å¦‚: è‰¾å°”ç™»æ³•ç¯, è¤ªè‰²è€…, Elden Ring">
                                </div>
                                <div class="w-32">
                                    <label class="block text-xs font-bold text-gray-700 mb-2">çŠ¶æ€</label>
                                    <button @click="wiModal.entries[wiModal.selectedIndex].enabled = !wiModal.entries[wiModal.selectedIndex].enabled" 
                                            :class="['w-full py-2.5 rounded-lg text-sm font-bold border-2 transition', 
                                                     wiModal.entries[wiModal.selectedIndex].enabled !== false 
                                                     ? 'bg-green-50 text-green-700 border-green-300' 
                                                     : 'bg-gray-50 text-gray-500 border-gray-300']">
                                        {{ wiModal.entries[wiModal.selectedIndex].enabled !== false ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨' }}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- å†…å®¹ç¼–è¾‘å™¨ -->
                            <div class="flex flex-col" style="min-height: 400px;">
                                <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-3.5 h-3.5 text-green-500"></i>
                                    è¯æ¡å†…å®¹ (Content)
                                </label>
                                <textarea v-model="wiModal.entries[wiModal.selectedIndex].content" 
                                          class="flex-1 w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400/30 focus:border-green-400 text-sm font-mono bg-gray-50 leading-relaxed transition resize-none"
                                          style="min-height: 350px;"
                                          placeholder="è¾“å…¥è¯æ¡å†…å®¹ï¼Œå½“å…³é”®è¯è¢«è§¦å‘æ—¶ä¼šæ’å…¥åˆ°å¯¹è¯ä¸­..."></textarea>
                                <p class="text-xs text-gray-500 mt-2">
                                    å½“å¯¹è¯ä¸­å‡ºç°å…³é”®è¯æ—¶ï¼Œè¿™æ®µå†…å®¹ä¼šè¢«è‡ªåŠ¨æ’å…¥ï¼Œå¸®åŠ©AIç†è§£èƒŒæ™¯ä¿¡æ¯
                                </p>
                            </div>
                            
                            <!-- é«˜çº§é€‰é¡¹ -->
                            <div class="border-t-2 border-gray-200 pt-5 mt-5">
                                <h5 class="font-bold text-sm text-gray-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="settings" class="w-4 h-4 text-purple-500"></i>
                                    é«˜çº§é€‰é¡¹ (Advanced Options)
                                </h5>
                                
                                <div class="grid grid-cols-3 gap-4">
                                    <!-- Insertion Order -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                            <i data-lucide="arrow-down-up" class="w-3 h-3 text-purple-500"></i>
                                            æ’å…¥é¡ºåº (Insertion Order)
                                        </label>
                                        <input v-model.number="wiModal.entries[wiModal.selectedIndex].insertion_order" 
                                               type="number"
                                               class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400/30 focus:border-purple-400 text-sm font-bold transition"
                                               placeholder="100">
                                        <p class="text-xs text-gray-500 mt-1">æ•°å­—è¶Šå°è¶Šä¼˜å…ˆæ’å…¥</p>
                                    </div>
                                    
                                    <!-- Case Sensitive -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                            <i data-lucide="case-sensitive" class="w-3 h-3 text-orange-500"></i>
                                            å¤§å°å†™æ•æ„Ÿ
                                        </label>
                                        <button @click="wiModal.entries[wiModal.selectedIndex].case_sensitive = !wiModal.entries[wiModal.selectedIndex].case_sensitive" 
                                                :class="['w-full py-2 rounded-lg text-sm font-bold border-2 transition', 
                                                         wiModal.entries[wiModal.selectedIndex].case_sensitive 
                                                         ? 'bg-orange-50 text-orange-700 border-orange-300' 
                                                         : 'bg-gray-50 text-gray-500 border-gray-300']">
                                            {{ wiModal.entries[wiModal.selectedIndex].case_sensitive ? 'âœ“ æ•æ„Ÿ' : 'âœ— å¿½ç•¥' }}
                                        </button>
                                        <p class="text-xs text-gray-500 mt-1">æ˜¯å¦åŒºåˆ†å¤§å°å†™</p>
                                    </div>
                                    
                                    <!-- Priority -->
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                            <i data-lucide="star" class="w-3 h-3 text-yellow-500"></i>
                                            ä¼˜å…ˆçº§ (Priority)
                                        </label>
                                        <input v-model.number="wiModal.entries[wiModal.selectedIndex].priority" 
                                               type="number"
                                               class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400/30 focus:border-yellow-400 text-sm font-bold transition"
                                               placeholder="0">
                                        <p class="text-xs text-gray-500 mt-1">é«˜ä¼˜å…ˆçº§ä¼˜å…ˆå¤„ç†</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æœªé€‰ä¸­çŠ¶æ€ -->
                <div v-else class="flex-1 flex items-center justify-center bg-gray-50">
                    <div class="text-center">
                        <i data-lucide="mouse-pointer-click" class="w-20 h-20 mx-auto mb-4 opacity-10 text-gray-400"></i>
                        <p class="text-base font-bold text-gray-500 mb-1">æœªé€‰æ‹©è¯æ¡</p>
                        <p class="text-sm text-gray-400">ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè¯æ¡æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regex è„šæœ¬æŸ¥çœ‹å™¨ - å®Œå…¨é‡åš ST é£æ ¼ -->
    <div v-if="regexModal.visible" @click.self="regexModal.visible = false" class="fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[88vh] flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-rose-100 flex items-center justify-center">
                        <i data-lucide="code" class="w-5 h-5 text-rose-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-gray-900">æ­£åˆ™è¡¨è¾¾å¼è„šæœ¬ (Regex Scripts)</h3>
                        <p class="text-xs text-gray-500 font-medium">å…± {{regexModal.scripts.length}} ä¸ªè„šæœ¬</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="addRegexScript" class="px-4 py-2 bg-rose-500 text-white rounded-lg text-sm font-bold hover:bg-rose-600 transition flex items-center gap-2 shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> æ–°å»ºè„šæœ¬
                    </button>
                    <button @click="regexModal.visible = false" class="p-2 hover:bg-gray-200 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-hidden flex">
                <!-- å·¦ä¾§è„šæœ¬åˆ—è¡¨ -->
                <div class="w-80 border-r border-gray-200 overflow-y-auto bg-gray-50 custom-scrollbar">
                    <div v-if="regexModal.scripts.length === 0" class="p-12 text-center">
                        <i data-lucide="file-x" class="w-16 h-16 mx-auto mb-4 opacity-20 text-gray-400"></i>
                        <p class="text-sm font-semibold text-gray-500 mb-1">æš‚æ— æ­£åˆ™è„šæœ¬</p>
                        <p class="text-xs text-gray-400">ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®åˆ›å»º</p>
                    </div>
                    
                    <div class="p-3 space-y-2">
                        <div v-for="(script, idx) in regexModal.scripts" :key="idx" 
                            @click="regexModal.selectedIndex = idx"
                            :class="['p-3 cursor-pointer transition-all rounded-lg border-2 bg-white', 
                                     regexModal.selectedIndex === idx 
                                     ? 'border-rose-400 shadow-md ring-2 ring-rose-100' 
                                     : 'border-gray-200 hover:border-gray-300 hover:shadow-sm']">
                            <div class="flex items-start justify-between mb-2">
                                <div class="font-bold text-sm text-gray-900 flex-1 pr-2">
                                    {{script.scriptName || 'Unnamed Script'}}
                                </div>
                                <span :class="['px-2 py-0.5 rounded-full text-[10px] font-bold shrink-0', 
                                               regexModal.selectedIndex === idx ? 'bg-rose-100 text-rose-700' : 'bg-gray-100 text-gray-600']">
                                    #{{idx + 1}}
                                </span>
                            </div>
                            <!-- æ˜¾ç¤ºå®Œæ•´æ­£åˆ™å†…å®¹ï¼Œä¸æˆªæ–­ -->
                            <div class="text-xs text-gray-600 font-mono bg-gray-50 px-2 py-2 rounded border border-gray-200 whitespace-pre-wrap break-all leading-relaxed max-h-24 overflow-y-auto custom-scrollbar">
                                {{script.regex || '(ç©ºæ­£åˆ™è¡¨è¾¾å¼)'}}
                            </div>
                            <div class="flex items-center gap-2 mt-2 text-[10px]">
                                <span class="px-2 py-0.5 bg-blue-50 text-blue-700 rounded font-mono font-bold">{{script.regexFlags || 'gm'}}</span>
                                <span class="text-gray-300">â€¢</span>
                                <span class="text-gray-500">Position: <span class="font-bold text-gray-700">{{script.regexPlacement || 1}}</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§è¯¦æƒ…åŒº -->
                <div v-if="regexModal.selectedIndex !== -1 && regexModal.scripts[regexModal.selectedIndex]" class="flex-1 overflow-y-auto bg-white custom-scrollbar">
                    <div class="max-w-5xl mx-auto p-6">
                        <!-- æ“ä½œæŒ‰é’®æ  -->
                        <div class="flex justify-between items-center mb-5 pb-4 border-b border-gray-200">
                            <h4 class="font-black text-lg text-gray-900">è„šæœ¬è¯¦æƒ…</h4>
                            <button @click="deleteRegexScript(regexModal.selectedIndex)" 
                                    class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 transition flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> åˆ é™¤
                            </button>
                        </div>
                        
                        <!-- è¡¨å•åŒºåŸŸ -->
                        <div class="space-y-5">
                            <!-- è„šæœ¬åç§° -->
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i data-lucide="tag" class="w-3.5 h-3.5 text-rose-500"></i>
                                    è„šæœ¬åç§° (Script Name)
                                </label>
                                <input v-model="regexModal.scripts[regexModal.selectedIndex].scriptName" 
                                       class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-400/30 focus:border-rose-400 text-sm font-semibold transition"
                                       placeholder="ä¾‹å¦‚: ç§»é™¤HTMLæ ‡ç­¾">
                            </div>
                            
                            <!-- æ­£åˆ™è¡¨è¾¾å¼ -->
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i data-lucide="code" class="w-3.5 h-3.5 text-blue-500"></i>
                                    æ­£åˆ™è¡¨è¾¾å¼ (Regex Pattern)
                                </label>
                                <textarea v-model="regexModal.scripts[regexModal.selectedIndex].regex" 
                                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400/30 focus:border-blue-400 text-sm font-mono bg-gray-50 leading-relaxed transition" 
                                          rows="4"
                                          placeholder="è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚: <[^>]*>"></textarea>
                                <p class="text-xs text-gray-500 mt-2">æ”¯æŒæ ‡å‡†æ­£åˆ™è¯­æ³•ï¼Œä½¿ç”¨ () åˆ›å»ºæ•è·ç»„</p>
                            </div>
                            
                            <!-- æ›¿æ¢å†…å®¹ -->
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i data-lucide="repeat" class="w-3.5 h-3.5 text-green-500"></i>
                                    æ›¿æ¢å†…å®¹ (Replacement)
                                </label>
                                <textarea v-model="regexModal.scripts[regexModal.selectedIndex].regexReplacement" 
                                          class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400/30 focus:border-green-400 text-sm font-mono bg-gray-50 leading-relaxed transition" 
                                          rows="3"
                                          placeholder="è¾“å…¥æ›¿æ¢æ–‡æœ¬ï¼Œä½¿ç”¨ $1, $2 å¼•ç”¨æ•è·ç»„"></textarea>
                                <p class="text-xs text-gray-500 mt-2">ä½¿ç”¨ $1, $2... å¼•ç”¨æ­£åˆ™ä¸­çš„æ•è·ç»„</p>
                            </div>
                            
                            <!-- Placement å’Œ Flags -->
                            <div class="grid grid-cols-2 gap-5">
                                <!-- Placement æŒ‰é’®ç»„ -->
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="layers" class="w-3.5 h-3.5 text-purple-500"></i>
                                        æ‰§è¡Œä½ç½® (Placement)
                                    </label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button v-for="p in [[1,'Before UI'], [2,'After UI'], [3,'Before Char'], [4,'After Char']]" :key="p[0]"
                                                @click="regexModal.scripts[regexModal.selectedIndex].regexPlacement = p[0]"
                                                :class="['px-3 py-2 rounded-lg text-xs font-bold border-2 transition', 
                                                         regexModal.scripts[regexModal.selectedIndex].regexPlacement === p[0] 
                                                         ? 'bg-purple-500 text-white border-purple-600' 
                                                         : 'bg-white text-gray-600 border-gray-200 hover:border-purple-300']">
                                            {{p[1]}}
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">æ§åˆ¶è„šæœ¬æ‰§è¡Œçš„æ—¶æœº</p>
                                </div>
                                
                                <!-- Regex Flags -->
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <i data-lucide="flag" class="w-3.5 h-3.5 text-orange-500"></i>
                                        æ­£åˆ™æ ‡å¿— (Flags)
                                    </label>
                                    <input v-model="regexModal.scripts[regexModal.selectedIndex].regexFlags" 
                                           class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400/30 focus:border-orange-400 text-sm font-mono font-bold transition"
                                           placeholder="gm">
                                    <p class="text-xs text-gray-500 mt-2">g(å…¨å±€) m(å¤šè¡Œ) i(å¿½ç•¥å¤§å°å†™)</p>
                                </div>
                            </div>
                            
                            <!-- æµ‹è¯•åŒºåŸŸ -->
                            <div class="border-t-2 border-gray-200 pt-6 mt-6">
                                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-5 rounded-xl border-2 border-indigo-200">
                                    <h5 class="font-black text-sm text-gray-900 mb-4 flex items-center gap-2">
                                        <i data-lucide="play-circle" class="w-5 h-5 text-indigo-600"></i>
                                        å®æ—¶æµ‹è¯• (Live Test)
                                        <span class="text-xs font-normal text-gray-500 ml-2">* JavaScriptæ¨¡æ‹Ÿï¼Œä¸STçš„Pythonå®ç°å¯èƒ½ç•¥æœ‰å·®å¼‚</span>
                                    </h5>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">è¾“å…¥æ–‡æœ¬</label>
                                            <textarea v-model="regexModal.testInput" 
                                                      class="w-full px-3 py-2 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400/30 focus:border-indigo-400 text-xs bg-white leading-relaxed transition" 
                                                      rows="6" 
                                                      placeholder="åœ¨æ­¤è¾“å…¥æµ‹è¯•æ–‡æœ¬..."></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-1">
                                                <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                                å¤„ç†ç»“æœ
                                            </label>
                                            <div class="w-full px-3 py-2 bg-white border-2 border-indigo-300 rounded-lg text-xs font-mono whitespace-pre-wrap leading-relaxed shadow-inner h-[152px] overflow-y-auto custom-scrollbar">
                                                <span v-if="!regexModal.testInput" class="text-gray-400 italic">ç­‰å¾…è¾“å…¥...</span>
                                                <span v-else class="text-gray-900">{{runRegexTest(regexModal.scripts[regexModal.selectedIndex], regexModal.testInput)}}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æœªé€‰ä¸­çŠ¶æ€ -->
                <div v-else class="flex-1 flex items-center justify-center bg-gray-50">
                    <div class="text-center">
                        <i data-lucide="mouse-pointer-click" class="w-20 h-20 mx-auto mb-4 opacity-10 text-gray-400"></i>
                        <p class="text-base font-bold text-gray-500 mb-1">æœªé€‰æ‹©è„šæœ¬</p>
                        <p class="text-sm text-gray-400">ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªè„šæœ¬æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡æ–°è®¾è®¡çš„è¯¦ç»†å¯¹æ¯”æ¨¡æ€æ¡† -->
    <div v-if="showDiff" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-[32px] shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <span class="font-black text-lg flex items-center gap-3 text-gray-800"><i data-lucide="scale" class="text-rose-500"></i> æ¡£æ¡ˆæ·±åº¦å¯¹æ¯” (Diff Check)</span>
                <button @click="showDiff = false" class="w-10 h-10 flex items-center justify-center hover:bg-gray-200 rounded-full transition-colors"><i data-lucide="x"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-slate-50/50">
                <div class="grid grid-cols-2 gap-8">
                    <!-- å¡ç‰‡ A -->
                    <div class="flex flex-col gap-6">
                        <!-- å¤´éƒ¨ä¿¡æ¯ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm flex gap-5 items-start">
                             <img :src="diffCards[0].imgUrl" class="w-20 h-20 rounded-xl object-cover bg-gray-100 border border-gray-100">
                             <div class="flex-1 min-w-0">
                                 <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Card A (Keep Left)</div>
                                 <div class="text-lg font-black truncate text-gray-800">{{diffCards[0].data.name}}</div>
                                 <div class="text-xs font-mono text-gray-400 truncate">{{diffCards[0].fileName}}</div>
                                 <div v-if="diffCards[0].quickReplies" class="mt-2 flex items-center gap-1.5 text-[10px] text-purple-600 bg-purple-50 px-2 py-1 rounded-lg border border-purple-200 w-fit">
                                     <i data-lucide="zap" class="w-3 h-3"></i>
                                     <span class="font-bold">æœ‰å¿«é€Ÿå›å¤</span>
                                 </div>
                                 <div class="mt-3 flex gap-2">
                                     <button @click="keepCard(diffCards[0].id)" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-rose-500 transition shadow-lg shadow-gray-200">ä¿ç•™æ­¤ç‰ˆæœ¬</button>
                                     <button v-if="diffCards[1].quickReplies" @click="transferQuickReplies(diffCards[1].id, diffCards[0].id)" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl text-xs font-bold hover:bg-purple-200 transition border border-purple-300" title="ä»å³ä¾§å¡ç‰‡è½¬ç§»å¿«é€Ÿå›å¤">
                                         <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                                     </button>
                                 </div>
                             </div>
                        </div>

                        <!-- ç»Ÿè®¡å¯¹æ¯”ï¼šDescription -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm" :class="{'ring-2 ring-rose-200 bg-rose-50/30': (diffCards[0].data.description||'').length !== (diffCards[1].data.description||'').length}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Description å­—æ•°</span>
                                <span class="text-lg font-black font-mono" :class="(diffCards[0].data.description||'').length > (diffCards[1].data.description||'').length ? 'text-green-600' : 'text-gray-700'">
                                    {{(diffCards[0].data.description||'').length}}
                                </span>
                            </div>
                            <div class="h-48 overflow-y-auto custom-scrollbar text-xs leading-relaxed font-mono text-gray-600 bg-gray-50 p-3 rounded-xl border border-gray-100 whitespace-pre-wrap">{{diffCards[0].data.description}}</div>
                        </div>

                        <!-- ç»Ÿè®¡å¯¹æ¯”ï¼šFirst Message -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm" :class="{'ring-2 ring-rose-200 bg-rose-50/30': (diffCards[0].data.first_mes||'').length !== (diffCards[1].data.first_mes||'').length}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">First Message å­—æ•°</span>
                                <span class="text-lg font-black font-mono" :class="(diffCards[0].data.first_mes||'').length > (diffCards[1].data.first_mes||'').length ? 'text-green-600' : 'text-gray-700'">
                                    {{(diffCards[0].data.first_mes||'').length}}
                                </span>
                            </div>
                            <div class="h-48 overflow-y-auto custom-scrollbar text-xs leading-relaxed font-mono text-gray-600 bg-gray-50 p-3 rounded-xl border border-gray-100 whitespace-pre-wrap">{{diffCards[0].data.first_mes}}</div>
                        </div>

                        <!-- NEW: å¼€åœºç™½ç»Ÿè®¡ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">å¼€åœºç™½æ•°é‡</span>
                                <span class="text-lg font-black font-mono text-green-600">
                                    {{getFirstMessagesCount(diffCards[0])}}
                                </span>
                            </div>
                            <div class="space-y-2">
                                <div class="p-2 rounded-lg text-xs border border-gray-100" :class="(diffCards[0].data.first_mes||'').length !== (diffCards[1].data.first_mes||'').length ? 'ring-2 ring-rose-200 bg-rose-50/30' : 'bg-blue-50'">
                                    <span class="font-bold text-gray-700">ä¸»å¼€åœºç™½:</span>
                                    <span class="ml-2 font-bold" :class="(diffCards[0].data.first_mes||'').length > (diffCards[1].data.first_mes||'').length ? 'text-blue-600' : 'text-gray-600'">{{(diffCards[0].data.first_mes||'').length}} å­—ç¬¦</span>
                                </div>
                                <div v-if="(diffCards[0].data.alternate_greetings||[]).length > 0" class="space-y-1">
                                    <div v-for="(alt, idx) in (diffCards[0].data.alternate_greetings||[])" :key="idx" class="p-2 rounded-lg text-xs flex justify-between border border-gray-100" :class="(alt||'').length !== ((diffCards[1].data.alternate_greetings||[])[idx]||'').length ? 'ring-2 ring-rose-200 bg-rose-50/30' : 'bg-gray-50'">
                                        <span class="text-gray-700">å¤‡ç”¨ #{{idx+1}}:</span>
                                        <span class="font-bold" :class="(alt||'').length > ((diffCards[1].data.alternate_greetings||[])[idx]||'').length ? 'text-blue-600' : 'text-gray-600'">{{(alt||'').length}} å­—ç¬¦</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: ä¸–ç•Œä¹¦ç»Ÿè®¡ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ä¸–ç•Œä¹¦ (Lorebook)</span>
                                <span class="text-lg font-black font-mono text-purple-600">
                                    {{getWorldInfoCount(diffCards[0])}} æ¡
                                </span>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">æ€»å­—ç¬¦æ•°:</div>
                                <div class="text-2xl font-black text-purple-700">{{getWorldInfoTotalChars(diffCards[0]).toLocaleString()}}</div>
                            </div>
                        </div>
                    </div>

                    <!-- å¡ç‰‡ B -->
                    <div class="flex flex-col gap-6">
                        <!-- å¤´éƒ¨ä¿¡æ¯ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm flex gap-5 items-start">
                             <img :src="diffCards[1].imgUrl" class="w-20 h-20 rounded-xl object-cover bg-gray-100 border border-gray-100">
                             <div class="flex-1 min-w-0">
                                 <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Card B (Keep Right)</div>
                                 <div class="text-lg font-black truncate text-gray-800">{{diffCards[1].data.name}}</div>
                                 <div class="text-xs font-mono text-gray-400 truncate">{{diffCards[1].fileName}}</div>
                                 <div v-if="diffCards[1].quickReplies" class="mt-2 flex items-center gap-1.5 text-[10px] text-purple-600 bg-purple-50 px-2 py-1 rounded-lg border border-purple-200 w-fit">
                                     <i data-lucide="zap" class="w-3 h-3"></i>
                                     <span class="font-bold">æœ‰å¿«é€Ÿå›å¤</span>
                                 </div>
                                 <div class="mt-3 flex gap-2">
                                     <button v-if="diffCards[0].quickReplies" @click="transferQuickReplies(diffCards[0].id, diffCards[1].id)" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl text-xs font-bold hover:bg-purple-200 transition border border-purple-300" title="ä»å·¦ä¾§å¡ç‰‡è½¬ç§»å¿«é€Ÿå›å¤">
                                         <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                                     </button>
                                     <button @click="keepCard(diffCards[1].id)" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-rose-500 transition shadow-lg shadow-gray-200">ä¿ç•™æ­¤ç‰ˆæœ¬</button>
                                 </div>
                             </div>
                        </div>

                         <!-- ç»Ÿè®¡å¯¹æ¯”ï¼šDescription -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm" :class="{'ring-2 ring-rose-200 bg-rose-50/30': (diffCards[0].data.description||'').length !== (diffCards[1].data.description||'').length}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Description å­—æ•°</span>
                                <span class="text-lg font-black font-mono" :class="(diffCards[1].data.description||'').length > (diffCards[0].data.description||'').length ? 'text-green-600' : 'text-gray-700'">
                                    {{(diffCards[1].data.description||'').length}}
                                </span>
                            </div>
                            <div class="h-48 overflow-y-auto custom-scrollbar text-xs leading-relaxed font-mono text-gray-600 bg-gray-50 p-3 rounded-xl border border-gray-100 whitespace-pre-wrap">{{diffCards[1].data.description}}</div>
                        </div>

                        <!-- ç»Ÿè®¡å¯¹æ¯”ï¼šFirst Message -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm" :class="{'ring-2 ring-rose-200 bg-rose-50/30': (diffCards[0].data.first_mes||'').length !== (diffCards[1].data.first_mes||'').length}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">First Message å­—æ•°</span>
                                <span class="text-lg font-black font-mono" :class="(diffCards[1].data.first_mes||'').length > (diffCards[0].data.first_mes||'').length ? 'text-green-600' : 'text-gray-700'">
                                    {{(diffCards[1].data.first_mes||'').length}}
                                </span>
                            </div>
                            <div class="h-48 overflow-y-auto custom-scrollbar text-xs leading-relaxed font-mono text-gray-600 bg-gray-50 p-3 rounded-xl border border-gray-100 whitespace-pre-wrap">{{diffCards[1].data.first_mes}}</div>
                        </div>

                        <!-- NEW: å¼€åœºç™½ç»Ÿè®¡ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">å¼€åœºç™½æ•°é‡</span>
                                <span class="text-lg font-black font-mono text-green-600">
                                    {{getFirstMessagesCount(diffCards[1])}}
                                </span>
                            </div>
                            <div class="space-y-2">
                                <div class="p-2 rounded-lg text-xs border border-gray-100" :class="(diffCards[1].data.first_mes||'').length !== (diffCards[0].data.first_mes||'').length ? 'ring-2 ring-rose-200 bg-rose-50/30' : 'bg-blue-50'">
                                    <span class="font-bold text-gray-700">ä¸»å¼€åœºç™½:</span>
                                    <span class="ml-2 font-bold" :class="(diffCards[1].data.first_mes||'').length > (diffCards[0].data.first_mes||'').length ? 'text-blue-600' : 'text-gray-600'">{{(diffCards[1].data.first_mes||'').length}} å­—ç¬¦</span>
                                </div>
                                <div v-if="(diffCards[1].data.alternate_greetings||[]).length > 0" class="space-y-1">
                                    <div v-for="(alt, idx) in (diffCards[1].data.alternate_greetings||[])" :key="idx" class="p-2 rounded-lg text-xs flex justify-between border border-gray-100" :class="(alt||'').length !== ((diffCards[0].data.alternate_greetings||[])[idx]||'').length ? 'ring-2 ring-rose-200 bg-rose-50/30' : 'bg-gray-50'">
                                        <span class="text-gray-700">å¤‡ç”¨ #{{idx+1}}:</span>
                                        <span class="font-bold" :class="(alt||'').length > ((diffCards[0].data.alternate_greetings||[])[idx]||'').length ? 'text-blue-600' : 'text-gray-600'">{{(alt||'').length}} å­—ç¬¦</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: ä¸–ç•Œä¹¦ç»Ÿè®¡ -->
                        <div class="bg-white p-5 rounded-3xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">ä¸–ç•Œä¹¦ (Lorebook)</span>
                                <span class="text-lg font-black font-mono text-purple-600">
                                    {{getWorldInfoCount(diffCards[1])}} æ¡
                                </span>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">æ€»å­—ç¬¦æ•°:</div>
                                <div class="text-2xl font-black text-purple-700">{{getWorldInfoTotalChars(diffCards[1]).toLocaleString()}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ä¿®æ”¹æ¨¡æ€æ¡† -->
    <div v-if="showBatchModal" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-[400px] rounded-[32px] p-8 shadow-2xl space-y-6">
            <h3 class="font-black text-xl">æ‰¹é‡ä¿®æ”¹å±æ€§</h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">åˆ›å»ºè€… (Creator)</label>
                    <input v-model="batchForm.creator" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-xs focus:ring-2 focus:ring-rose-500/20">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">è¿½åŠ æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                    <input v-model="batchForm.tagsToAdd" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-xs focus:ring-2 focus:ring-rose-500/20">
                </div>
            </div>
            <div class="flex gap-3 pt-2">
                <button @click="applyBatchEdit" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold shadow-lg shadow-rose-100 hover:bg-rose-600">ç¡®è®¤ä¿®æ”¹</button>
                <button @click="showBatchModal = false" class="px-6 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥å¤±è´¥å¼¹çª— -->
    <div v-if="showErrorModal" class="fixed inset-0 z-[200] bg-black/50 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-[500px] max-h-[80vh] rounded-[32px] shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-200">
            <div class="px-8 py-5 border-b border-gray-100 bg-rose-50 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-rose-100 flex items-center justify-center text-rose-600">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-gray-800">å¯¼å…¥é‡åˆ°é—®é¢˜</h3>
                        <p class="text-xs text-rose-600 font-bold">{{importErrors.length}} ä¸ªæ–‡ä»¶è§£æå¤±è´¥</p>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-3 custom-scrollbar">
                <div v-for="(err, i) in importErrors" :key="i" class="p-3 bg-gray-50 rounded-xl border border-gray-100 flex gap-3 items-start">
                    <i data-lucide="file-x" class="w-4 h-4 text-gray-400 mt-0.5 shrink-0"></i>
                    <div class="min-w-0">
                        <div class="text-xs font-bold text-gray-700 truncate">{{err.name}}</div>
                        <div class="text-[10px] text-gray-400 mt-0.5 break-all">{{err.error}}</div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-white">
                <button @click="showErrorModal = false; importErrors = []" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶å¤¹ç®¡ç†å¼¹çª— -->
    <div v-if="folderModal.visible" class="fixed inset-0 z-[150] bg-black/40 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-[400px] rounded-[32px] p-8 shadow-2xl space-y-6 animate-in fade-in zoom-in-95 duration-200">
            <h3 class="font-black text-xl flex items-center gap-2">
                <i data-lucide="folder-cog" class="text-blue-500"></i>
                {{ folderModal.isEdit ? 'ç¼–è¾‘æ–‡ä»¶å¤¹' : 'æ–°å»ºæ–‡ä»¶å¤¹' }}
            </h3>
            
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase">æ–‡ä»¶å¤¹åç§° (Label)</label>
                <input v-model="folderModal.name" @keyup.enter="handleFolderSave" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all font-bold text-gray-700" placeholder="ä¾‹å¦‚: æ”¶è—, å¾…åŠ..." autoFocus>
            </div>

            <div class="flex flex-col gap-2 pt-2">
                <button @click="handleFolderSave" class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-600 transition flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> ä¿å­˜è®¾ç½®
                </button>
                
                <div class="flex gap-2">
                    <button v-if="folderModal.isEdit" @click="handleFolderDelete" class="flex-1 py-3 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl font-bold transition flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> åˆ é™¤
                    </button>
                    <button @click="folderModal.visible = false" class="flex-1 py-3 bg-gray-100 text-gray-500 hover:bg-gray-200 rounded-xl font-bold transition">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick, watch, onMounted } = Vue;

    // IndexedDB Helper
    const DB_NAME = 'STManagerDB_v1';
    const STORE_NAME = 'cards';
    
    const openDB = () => {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = () => reject("DB Open Error");
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
            };
        });
    };

    const dbOp = async (mode, callback) => {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, mode);
        const store = tx.objectStore(STORE_NAME);
        return new Promise((resolve, reject) => {
            const req = callback(store);
            tx.oncomplete = () => resolve(req?.result);
            tx.onerror = () => reject(tx.error);
        });
    };

    createApp({
        setup() {
            const cards = ref([]);
            const selectedIds = ref([]);
            const isEditMode = ref(false);
            const search = ref('');
            const viewMode = ref('all');
            const currentTag = ref(null);
            const sortBy = ref('time-desc');
            const showDiff = ref(false);
            const showBatchModal = ref(false);
            const batchForm = ref({ creator: '', tagsToAdd: '' });
            const tagManageMode = ref(false);
            const customFolders = ref(JSON.parse(localStorage.getItem('st_folders') || '[]'));
            const selectedFolderForExport = ref(null); // ç”¨äºå¯¼å‡ºçš„é€‰ä¸­æ–‡ä»¶å¤¹
            const showFirstMesModal = ref(false);
            const viewingAltIndex = ref(-1);
            const isLoading = ref(true);
            const firstMesPreview = ref(false);
            const lastClickedIndex = ref(-1); // Shiftå¤šé€‰ç”¨
            
            // QR ç®¡ç†ç›¸å…³
            const availableQRs = ref([]); // å­˜å‚¨æ‰€æœ‰å¯¼å…¥çš„ QR æ–‡ä»¶
            const pendingQRBind = ref(null); // ä¸´æ—¶å­˜å‚¨å¾…ç»‘å®šçš„ QR ä¿¡æ¯ { cardId, qrData, qrFileName }
            const showQRSection = ref(true); // æ§åˆ¶ QR åŒºåŸŸçš„æ˜¾ç¤º
            const qrManageMode = ref(false); // QR ç®¡ç†æ¨¡å¼
            const selectedQRIds = ref([]); // é€‰ä¸­çš„ QR ç´¢å¼•åˆ—è¡¨
            const lastClickedQRIndex = ref(-1); // Shiftå¤šé€‰ç”¨
            const showTagSection = ref(true); // æ§åˆ¶æ ‡ç­¾äº‘åŒºåŸŸçš„æ˜¾ç¤º
            
            // New State
            const importErrors = ref([]);
            const showErrorModal = ref(false);
            const folderModal = ref({ visible: false, isEdit: false, name: '', index: -1, oldName: '' });

            // New State for Advanced Features
            const wiModal = ref({ visible: false, entries: [], selectedIndex: -1 });
            const regexModal = ref({ visible: false, scripts: [], selectedIndex: -1, testInput: '' });

            // --- Pagination Logic (NEW) ---
            const itemsPerPage = ref(50);
            const currentPage = ref(1);
            const pageJumpInput = ref(1);

            // DB Persistence Methods
            const loadCardsFromDB = async () => {
                try {
                    isLoading.value = true;
                    const allRecords = await dbOp('readonly', store => store.getAll());
                    
                    // Reconstruct blob URLs
                    const restoredCards = allRecords.map(rec => ({
                        ...rec,
                        imgUrl: rec.blob ? URL.createObjectURL(rec.blob) : null,
                        originalFile: rec.blob // Restore blob as file source
                    }));
                    cards.value = restoredCards;
                } catch (e) {
                    console.error("Failed to load cards", e);
                } finally {
                    isLoading.value = false;
                }
            };

            const saveCardToDB = async (card) => {
                // Update lastModified timestamp
                card.lastModified = Date.now();
                
                // We store everything EXCEPT the ephemeral imgUrl
                const record = {
                    id: card.id,
                    fileName: card.fileName,
                    importDate: card.importDate,
                    fileLastModified: card.fileLastModified, // æ–‡ä»¶çœŸå®ä¿®æ”¹æ—¶é—´
                    lastModified: card.lastModified,
                    hasLore: card.hasLore,
                    data: JSON.parse(JSON.stringify(card.data)), // Deep copy data
                    blob: card.originalFile || card.newAvatarFile, // Store the raw blob/file
                    note: card.note || "",
                    quickReplies: card.quickReplies ? JSON.parse(JSON.stringify(card.quickReplies)) : null // æ·±æ‹·è´å¿«é€Ÿå›å¤
                };
                await dbOp('readwrite', store => store.put(record));
            };

            const deleteCardFromDB = async (id) => {
                await dbOp('readwrite', store => store.delete(id));
            };

            onMounted(() => {
                loadCardsFromDB();
                
                // ä» localStorage åŠ è½½ QR åˆ—è¡¨
                try {
                    const savedQRs = localStorage.getItem('st_available_qrs');
                    if (savedQRs) {
                        availableQRs.value = JSON.parse(savedQRs);
                    }
                } catch (err) {
                    console.error('Failed to load QRs from localStorage:', err);
                }
                
                lucide.createIcons();
            });

            watch(customFolders, (newVal) => {
                localStorage.setItem('st_folders', JSON.stringify(newVal));
            }, { deep: true });
            
            // ç›‘å¬ QR ç®¡ç†æ¨¡å¼å˜åŒ–ï¼Œé€€å‡ºæ—¶æ¸…ç©ºé€‰ä¸­
            watch(qrManageMode, (newVal) => {
                if (!newVal) {
                    selectedQRIds.value = [];
                    lastClickedQRIndex.value = -1;
                }
            });
            
            // Watchers for pagination reset
            watch([search, currentTag, viewMode, itemsPerPage], () => {
                currentPage.value = 1;
                pageJumpInput.value = 1;
            });

            // Computed currentBigGreeting
            const currentBigGreeting = computed({
                get() {
                    if(!activeCard.value) return '';
                    if(viewingAltIndex.value === -1) return activeCard.value.data.first_mes || '';
                    return activeCard.value.data.alternate_greetings?.[viewingAltIndex.value] || '';
                },
                set(val) {
                    if(!activeCard.value) return;
                    if(viewingAltIndex.value === -1) {
                        activeCard.value.data.first_mes = val;
                    } else {
                        if(!activeCard.value.data.alternate_greetings) activeCard.value.data.alternate_greetings = [];
                        activeCard.value.data.alternate_greetings[viewingAltIndex.value] = val;
                    }
                    // Auto-save changes to DB
                    saveCardToDB(activeCard.value);
                }
            });

            const allTags = computed(() => {
                const map = {};
                cards.value.forEach(c => {
                    (c.data.tags || []).forEach(t => {
                        const trimTag = t.trim();
                        if(trimTag) map[trimTag] = (map[trimTag] || 0) + 1;
                    });
                });
                return Object.entries(map).map(([name, count]) => ({ name, count })).sort((a,b) => b.count - a.count);
            });

            const filteredCards = computed(() => {
                let list = cards.value;
                if (viewMode.value === 'duplicates') {
                    const counts = {};
                    // ç§»é™¤åç§°ä¸­çš„"(å‰¯æœ¬)"åç¼€æ¥åˆ¤æ–­æ˜¯å¦é‡å¤
                    list.forEach(c => {
                        const baseName = c.data.name.replace(/\s*\(å‰¯æœ¬\)\s*$/, '').trim();
                        counts[baseName] = (counts[baseName] || 0) + 1;
                    });
                    list = list.filter(c => {
                        const baseName = c.data.name.replace(/\s*\(å‰¯æœ¬\)\s*$/, '').trim();
                        return counts[baseName] > 1;
                    });
                }
                if (currentTag.value) {
                    list = list.filter(c => (c.data.tags || []).some(t => t.trim() === currentTag.value));
                }
                if (search.value) {
                    const q = search.value.toLowerCase();
                    list = list.filter(c => c.data.name.toLowerCase().includes(q) || c.fileName.toLowerCase().includes(q));
                }
                return list.sort((a, b) => {
                    if (sortBy.value === 'name-asc') {
                        // åç§° A-Z
                        return a.data.name.localeCompare(b.data.name, 'zh-CN');
                    } else if (sortBy.value === 'name-desc') {
                        // åç§° Z-A
                        return b.data.name.localeCompare(a.data.name, 'zh-CN');
                    } else if (sortBy.value === 'time-asc') {
                        // æœ€æ—§æ—¶é—´
                        return a.importDate - b.importDate;
                    } else {
                        // é»˜è®¤ï¼šæœ€æ–°æ—¶é—´ (time-desc)
                        return b.importDate - a.importDate;
                    }
                });
            });

            // --- Pagination Computed (NEW) ---
            const paginatedCards = computed(() => {
                const start = (currentPage.value - 1) * itemsPerPage.value;
                const end = start + itemsPerPage.value;
                return filteredCards.value.slice(start, end);
            });

            // Duplicate View Logic - Grouping and Pagination
            const groupedCards = computed(() => {
                if (viewMode.value !== 'duplicates') return {};
                const groups = {};
                filteredCards.value.forEach(c => {
                    // ä½¿ç”¨åŸºç¡€åç§°ï¼ˆå»æ‰"(å‰¯æœ¬)"ï¼‰ä½œä¸ºåˆ†ç»„é”®
                    const baseName = c.data.name.replace(/\s*\(å‰¯æœ¬\)\s*$/, '').trim();
                    if (!groups[baseName]) groups[baseName] = [];
                    groups[baseName].push(c);
                });
                return groups;
            });

            const duplicateGroupsList = computed(() => {
                if (viewMode.value !== 'duplicates') return [];
                const groupsObj = groupedCards.value;
                return Object.entries(groupsObj).map(([name, list]) => ({ name, list })).sort((a, b) => a.name.localeCompare(b.name));
            });

            const paginatedGroups = computed(() => {
                 const start = (currentPage.value - 1) * itemsPerPage.value;
                 const end = start + itemsPerPage.value;
                 return duplicateGroupsList.value.slice(start, end);
            });

            const totalPages = computed(() => {
                let total = 0;
                if (viewMode.value === 'duplicates') {
                    total = duplicateGroupsList.value.length;
                } else {
                    total = filteredCards.value.length;
                }
                return Math.ceil(total / itemsPerPage.value) || 1;
            });

            const setPage = (p) => {
                let target = parseInt(p);
                if(isNaN(target)) target = 1;
                if(target < 1) target = 1;
                if(target > totalPages.value) target = totalPages.value;
                currentPage.value = target;
                pageJumpInput.value = target;
                document.querySelector('.custom-scrollbar')?.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const duplicateCount = computed(() => {
                const counts = {};
                // æŒ‰åŸºç¡€åç§°ï¼ˆå»æ‰"(å‰¯æœ¬)"ï¼‰è®¡æ•°
                cards.value.forEach(c => {
                    const baseName = c.data.name.replace(/\s*\(å‰¯æœ¬\)\s*$/, '').trim();
                    counts[baseName] = (counts[baseName] || 0) + 1;
                });
                return Object.values(counts).filter(n => n > 1).length;
            });

            const activeCard = computed(() => cards.value.find(c => c.id === selectedIds.value[0]));
            const diffCards = computed(() => cards.value.filter(c => selectedIds.value.includes(c.id)));

            const handleImport = async (e) => {
                const files = Array.from(e.target.files);
                importErrors.value = [];
                isLoading.value = true;
                
                try {
                    for (const file of files) {
                        try {
                            let raw;
                            let imageBlob = null;
                            let originalFormat = 'json'; // é»˜è®¤JSONæ ¼å¼
                            
                            if (file.type === 'image/png') {
                                raw = await parsePng(file);
                                imageBlob = file; // ä¿å­˜åŸå§‹PNGæ–‡ä»¶
                                originalFormat = 'png';
                            } else if (file.type === 'application/json' || file.name.endsWith('.json')) {
                                const buffer = await file.arrayBuffer();
                                raw = JSON.parse(new TextDecoder("utf-8").decode(buffer));
                                originalFormat = 'json';
                            } else {
                                throw new Error("åªæ”¯æŒPNGè§’è‰²å¡å’ŒJSONæ–‡ä»¶");
                            }
                            
                            const charData = raw.data || raw;
                            if(!charData || (!charData.name && !charData.description)) {
                               throw new Error("Invalid format: missing name/description"); 
                            }

                            let cleanTags = [];
                            if(Array.isArray(charData.tags)) {
                                cleanTags = charData.tags.map(t => String(t).trim()).filter(t => t);
                            }

                            const newCard = {
                                id: Math.random().toString(36).substr(2, 9),
                                fileName: file.name,
                                importDate: Date.now(),
                                fileLastModified: file.lastModified || Date.now(), // æ–‡ä»¶çœŸå®ä¿®æ”¹æ—¶é—´
                                lastModified: Date.now(), // ç®¡ç†å™¨ä¸­çš„ä¿®æ”¹æ—¶é—´
                                imgUrl: imageBlob ? URL.createObjectURL(imageBlob) : null,
                                hasLore: !!(charData.character_book?.entries?.length > 0),
                                originalFile: imageBlob, // ä¿å­˜PNGæ–‡ä»¶ç”¨äºå¯¼å‡º
                                originalFormat: originalFormat, // æ ‡è®°åŸå§‹æ ¼å¼
                                originalSpec: raw.spec || 'chara_card_v2', // ä¿å­˜specä¿¡æ¯
                                originalSpecVersion: raw.spec_version || '2.0', // ä¿å­˜spec_version
                                note: charData.note || "", // ä¿å­˜å¤‡æ³¨å­—æ®µ
                                quickReplies: null, // å¿«é€Ÿå›å¤æŒ‰é’®ï¼ˆJSONæ–‡ä»¶ï¼‰
                                data: {
                                    name: charData.name || "æœªå‘½å",
                                    description: charData.description || "",
                                    personality: charData.personality || "",
                                    scenario: charData.scenario || "",
                                    first_mes: charData.first_mes || "",
                                    mes_example: charData.mes_example || "",
                                    alternate_greetings: charData.alternate_greetings || [],
                                    tags: cleanTags,
                                    creator_notes: charData.creator_notes || "",
                                    creator: charData.creator || "",
                                    character_version: charData.character_version || "",
                                    system_prompt: charData.system_prompt || "",
                                    post_history_instructions: charData.post_history_instructions || "",
                                    character_book: charData.character_book,
                                    extensions: charData.extensions || {},
                                    group_only_greetings: charData.group_only_greetings || []
                                }
                            };
                            
                            await saveCardToDB(newCard); // Save to DB
                            cards.value.push(newCard); // Update UI
                        } catch (err) { 
                            console.error("è§£æå¤±è´¥:", file.name, err);
                            importErrors.value.push({
                                name: file.name,
                                error: err.message || "æ— æ³•è¯»å–æ–‡ä»¶æ•°æ®"
                            });
                        }
                    }
                } finally {
                    isLoading.value = false;
                    if(importErrors.value.length > 0) {
                        showErrorModal.value = true;
                    }
                    e.target.value = '';
                    nextTick(() => lucide.createIcons());
                }
            };

            // Improved PNG Parser to support iTXt and looser logic
            const parsePng = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        try {
                            const buffer = reader.result;
                            const view = new DataView(buffer);
                            if (view.getUint32(0) !== 0x89504e47 || view.getUint32(4) !== 0x0d0a1a0a) return reject("Not a valid PNG file");
                            let off = 8;
                            while(off < buffer.byteLength) {
                                const len = view.getUint32(off);
                                const type = String.fromCharCode(...new Uint8Array(buffer.slice(off+4, off+8)));
                                if (type === 'tEXt' || type === 'iTXt') {
                                    const chunkData = new Uint8Array(buffer.slice(off+8, off+8+len));
                                    let keywordEnd = chunkData.indexOf(0);
                                    let keyword = new TextDecoder("utf-8").decode(chunkData.slice(0, keywordEnd));
                                    if (keyword.toLowerCase() === 'chara') {
                                        let textData;
                                        if (type === 'tEXt') {
                                            textData = chunkData.slice(keywordEnd + 1);
                                        } else {
                                            // iTXt: keyword | 0 | compFlag | compMethod | langTag | 0 | transKey | 0 | text
                                            let cursor = keywordEnd + 1;
                                            const compFlag = chunkData[cursor++];
                                            const compMethod = chunkData[cursor++];
                                            const langTagEnd = chunkData.indexOf(0, cursor);
                                            cursor = langTagEnd + 1;
                                            const transKeyEnd = chunkData.indexOf(0, cursor);
                                            cursor = transKeyEnd + 1;
                                            textData = chunkData.slice(cursor);
                                        }
                                        const txt = new TextDecoder("utf-8").decode(textData);
                                        try {
                                            resolve(JSON.parse(txt)); return; // Try direct JSON
                                        } catch(e) {
                                            try {
                                                const binStr = atob(txt);
                                                const bytes = new Uint8Array(binStr.length);
                                                for (let i = 0; i < binStr.length; i++) bytes[i] = binStr.charCodeAt(i);
                                                resolve(JSON.parse(new TextDecoder("utf-8").decode(bytes))); return;
                                            } catch(e2) { resolve(JSON.parse(txt)); return; } // Fallback
                                        }
                                    }
                                }
                                off += 12 + len;
                            }
                            reject("Not a valid ST card");
                        } catch(err) { reject(err); }
                    };
                    reader.onerror = () => reject("Read error");
                    reader.readAsArrayBuffer(file);
                });
            };

            // æ–‡ä»¶å¤¹å¯¼å…¥å¤„ç†å‡½æ•°ï¼ˆåªå¯¼å…¥è§’è‰²å¡PNG/JSONï¼Œä¿æŒåŸæŠ¥é”™é€»è¾‘ï¼‰
            const handleFolderImport = async (e) => {
                const files = Array.from(e.target.files);
                importErrors.value = [];
                isLoading.value = true;
                
                try {
                    for (const file of files) {
                        // åªå¤„ç†PNGå’ŒJSONæ–‡ä»¶
                        if (file.type !== 'image/png' && file.type !== 'application/json' && !file.name.endsWith('.json')) {
                            continue; // è·³è¿‡å…¶ä»–æ–‡ä»¶
                        }
                        
                        try {
                            let raw;
                            let imageBlob = null;
                            
                            if (file.type === 'image/png') {
                                raw = await parsePng(file);
                                imageBlob = file;
                            } else if (file.type === 'application/json' || file.name.endsWith('.json')) {
                                const buffer = await file.arrayBuffer();
                                raw = JSON.parse(new TextDecoder("utf-8").decode(buffer));
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯ QR æ–‡ä»¶
                                if (raw.qrList || raw.quickReplySlots || (raw.data && (raw.data.qrList || raw.data.quickReplySlots))) {
                                    // è¿™æ˜¯ä¸€ä¸ª QR æ–‡ä»¶ï¼Œæ·»åŠ åˆ° QR åˆ—è¡¨
                                    const qrName = raw.name || file.name.replace('.json', '');
                                    const existingIndex = availableQRs.value.findIndex(qr => qr.fileName === file.name);
                                    
                                    const qrItem = {
                                        name: qrName,
                                        fileName: file.name,
                                        data: raw
                                    };
                                    
                                    if (existingIndex === -1) {
                                        availableQRs.value.push(qrItem);
                                    } else {
                                        availableQRs.value[existingIndex] = qrItem;
                                    }
                                    
                                    // ä¿å­˜ QR åˆ—è¡¨åˆ° localStorage
                                    localStorage.setItem('st_available_qrs', JSON.stringify(availableQRs.value));
                                    
                                    continue; // è·³è¿‡åç»­çš„è§’è‰²å¡å¤„ç†
                                }
                            } else {
                                throw new Error("åªæ”¯æŒPNGè§’è‰²å¡å’ŒJSONæ–‡ä»¶");
                            }
                            
                            const charData = raw.data || raw;
                            if(!charData || (!charData.name && !charData.description)) {
                               throw new Error("Invalid format: missing name/description"); 
                            }

                            let cleanTags = [];
                            if(Array.isArray(charData.tags)) {
                                cleanTags = charData.tags.map(t => String(t).trim()).filter(t => t);
                            }

                            const newCard = {
                                id: Math.random().toString(36).substr(2, 9),
                                fileName: file.name,
                                importDate: Date.now(),
                                fileLastModified: file.lastModified || Date.now(),
                                lastModified: Date.now(),
                                imgUrl: imageBlob ? URL.createObjectURL(imageBlob) : null,
                                hasLore: !!(charData.character_book?.entries?.length > 0),
                                originalFile: imageBlob,
                                note: charData.note || "",
                                quickReplies: null,
                                data: {
                                    name: charData.name || "æœªå‘½å",
                                    description: charData.description || "",
                                    personality: charData.personality || "",
                                    scenario: charData.scenario || "",
                                    first_mes: charData.first_mes || "",
                                    mes_example: charData.mes_example || "",
                                    alternate_greetings: charData.alternate_greetings || [],
                                    tags: cleanTags,
                                    creator_notes: charData.creator_notes || "",
                                    creator: charData.creator || "",
                                    system_prompt: charData.system_prompt || "",
                                    post_history_instructions: charData.post_history_instructions || "",
                                    character_book: charData.character_book,
                                    extensions: charData.extensions || {}
                                }
                            };
                            
                            await saveCardToDB(newCard);
                            cards.value.push(newCard);
                        } catch (err) { 
                            console.error("è§£æå¤±è´¥:", file.name, err);
                            importErrors.value.push({
                                name: file.name,
                                error: err.message || "æ— æ³•è¯»å–æ–‡ä»¶æ•°æ®"
                            });
                        }
                    }
                } finally {
                    isLoading.value = false;
                    if(importErrors.value.length > 0) {
                        showErrorModal.value = true;
                    }
                    e.target.value = '';
                    nextTick(() => lucide.createIcons());
                }
            };

            // å¯¼å…¥å¿«é€Ÿå›å¤JSON
            const importQuickReplies = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    activeCard.value.quickReplies = {
                        fileName: file.name,
                        data: data
                    };
                    
                    await saveCardToDB(activeCard.value);
                    e.target.value = '';
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };

            // ç§»é™¤å¿«é€Ÿå›å¤
            const removeQuickReplies = async () => {
                if (confirm('ç¡®å®šè¦ç§»é™¤å¿«é€Ÿå›å¤é…ç½®å—ï¼Ÿ')) {
                    activeCard.value.quickReplies = null;
                    await saveCardToDB(activeCard.value);
                }
            };

            // ä¸‹è½½å¿«é€Ÿå›å¤JSON
            const downloadQuickReplies = () => {
                if (!activeCard.value.quickReplies) return;
                
                const blob = new Blob([JSON.stringify(activeCard.value.quickReplies.data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = activeCard.value.quickReplies.fileName || 'quickReplies.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            // ========== QR æ‹–æ‹½ç›¸å…³å‡½æ•° ==========
            
            // æ‰‹åŠ¨å¯¼å…¥ QR æ–‡ä»¶
            const handleQRImport = async (e) => {
                const files = Array.from(e.target.files);
                
                for (const file of files) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ QR æ–‡ä»¶
                        if (data.qrList || data.quickReplySlots || (data.data && (data.data.qrList || data.data.quickReplySlots))) {
                            const qrName = data.name || file.name.replace('.json', '');
                            const existingIndex = availableQRs.value.findIndex(qr => qr.fileName === file.name);
                            
                            const qrItem = {
                                name: qrName,
                                fileName: file.name,
                                data: data
                            };
                            
                            if (existingIndex === -1) {
                                availableQRs.value.push(qrItem);
                            } else {
                                availableQRs.value[existingIndex] = qrItem;
                            }
                            
                            // ä¿å­˜åˆ° localStorage
                            localStorage.setItem('st_available_qrs', JSON.stringify(availableQRs.value));
                        } else {
                            alert(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æœ‰æ•ˆçš„ QR æ–‡ä»¶`);
                        }
                    } catch (err) {
                        alert(`å¯¼å…¥ ${file.name} å¤±è´¥: ${err.message}`);
                    }
                }
                
                e.target.value = '';
                nextTick(() => lucide.createIcons());
            };
            
            // ä» QR åˆ—è¡¨ä¸­ç§»é™¤
            const removeQRFromList = (index) => {
                if (confirm('ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤è¿™ä¸ª QR å—ï¼Ÿ')) {
                    availableQRs.value.splice(index, 1);
                    localStorage.setItem('st_available_qrs', JSON.stringify(availableQRs.value));
                }
            };
            
            // QR å¤šé€‰åˆ‡æ¢
            const toggleQRSelection = (index, event) => {
                if (event.shiftKey && lastClickedQRIndex.value !== -1) {
                    // Shift å¤šé€‰
                    const start = Math.min(lastClickedQRIndex.value, index);
                    const end = Math.max(lastClickedQRIndex.value, index);
                    const range = [];
                    for (let i = start; i <= end; i++) {
                        range.push(i);
                    }
                    // åˆ‡æ¢æ•´ä¸ªèŒƒå›´
                    const allSelected = range.every(i => selectedQRIds.value.includes(i));
                    if (allSelected) {
                        selectedQRIds.value = selectedQRIds.value.filter(id => !range.includes(id));
                    } else {
                        const newIds = range.filter(i => !selectedQRIds.value.includes(i));
                        selectedQRIds.value.push(...newIds);
                    }
                } else {
                    // å•é€‰åˆ‡æ¢
                    const idx = selectedQRIds.value.indexOf(index);
                    if (idx > -1) {
                        selectedQRIds.value.splice(idx, 1);
                    } else {
                        selectedQRIds.value.push(index);
                    }
                }
                lastClickedQRIndex.value = index;
            };
            
            // æ‰¹é‡åˆ é™¤ QR
            const batchDeleteQR = () => {
                if (selectedQRIds.value.length === 0) return;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedQRIds.value.length} ä¸ª QR å—ï¼Ÿ`)) {
                    // ä»å¤§åˆ°å°æ’åºç´¢å¼•ï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•å˜åŒ–
                    const sortedIndices = [...selectedQRIds.value].sort((a, b) => b - a);
                    sortedIndices.forEach(index => {
                        availableQRs.value.splice(index, 1);
                    });
                    localStorage.setItem('st_available_qrs', JSON.stringify(availableQRs.value));
                    selectedQRIds.value = [];
                    lastClickedQRIndex.value = -1;
                }
            };
            
            // QR æ‹–æ‹½å¼€å§‹
            const onQRDragStart = (e, qr) => {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('application/json', JSON.stringify({
                    type: 'qr',
                    qr: qr
                }));
            };
            
            // QR æ‹–æ‹½è¿›å…¥å¡ç‰‡
            const onQRDragEnter = (e, card) => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ QR æ‹–æ‹½
                const types = e.dataTransfer.types;
                if (types.includes('application/json')) {
                    e.currentTarget.classList.add('ring-4', 'ring-purple-300', 'bg-purple-50/30');
                }
            };
            
            // QR æ‹–æ‹½ç¦»å¼€å¡ç‰‡
            const onQRDragLeave = (e) => {
                e.currentTarget.classList.remove('ring-4', 'ring-purple-300', 'bg-purple-50/30');
            };
            
            // QR æ”¾ç½®åˆ°å¡ç‰‡ä¸Š
            const onQRDrop = (e, card) => {
                e.preventDefault();
                e.currentTarget.classList.remove('ring-4', 'ring-purple-300', 'bg-purple-50/30');
                
                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    
                    if (data.type === 'qr' && data.qr) {
                        // è®¾ç½®å¾…ç»‘å®šçŠ¶æ€
                        pendingQRBind.value = {
                            cardId: card.id,
                            qrData: data.qr.data,
                            qrFileName: data.qr.fileName
                        };
                    }
                } catch (err) {
                    console.error('QR drop failed:', err);
                }
            };
            
            // ç¡®è®¤ç»‘å®š QR
            const confirmQRBind = async () => {
                if (!pendingQRBind.value) return;
                
                const card = cards.value.find(c => c.id === pendingQRBind.value.cardId);
                if (card) {
                    card.quickReplies = {
                        fileName: pendingQRBind.value.qrFileName,
                        data: pendingQRBind.value.qrData
                    };
                    
                    await saveCardToDB(card);
                    
                    // å¦‚æœå½“å‰ç¼–è¾‘çš„å¡ç‰‡å°±æ˜¯è¿™ä¸ªå¡ç‰‡ï¼Œæ›´æ–° activeCard
                    if (activeCard.value && activeCard.value.id === card.id) {
                        activeCard.value.quickReplies = card.quickReplies;
                    }
                }
                
                pendingQRBind.value = null;
                nextTick(() => lucide.createIcons());
            };
            
            // å–æ¶ˆç»‘å®š QR
            const cancelQRBind = () => {
                pendingQRBind.value = null;
            };

            const handleCardClick = (id, event) => {
                if (isEditMode.value) {
                    const clickedIndex = paginatedCards.value.findIndex(c => c.id === id);
                    
                    // Shiftå¤šé€‰
                    if (event?.shiftKey && lastClickedIndex.value !== -1) {
                        const start = Math.min(lastClickedIndex.value, clickedIndex);
                        const end = Math.max(lastClickedIndex.value, clickedIndex);
                        const rangeIds = paginatedCards.value.slice(start, end + 1).map(c => c.id);
                        
                        // æ·»åŠ èŒƒå›´å†…çš„æ‰€æœ‰å¡ç‰‡
                        rangeIds.forEach(rangeId => {
                            if (!selectedIds.value.includes(rangeId)) {
                                selectedIds.value.push(rangeId);
                            }
                        });
                    } else {
                        // æ­£å¸¸å•é€‰/å–æ¶ˆ
                        const i = selectedIds.value.indexOf(id);
                        if(i > -1) selectedIds.value.splice(i, 1); 
                        else selectedIds.value.push(id);
                    }
                    
                    lastClickedIndex.value = clickedIndex;
                } else {
                    selectedIds.value = [id];
                    lastClickedIndex.value = -1;
                }
            };
            const selectAll = () => { 
                // åªé€‰æ‹©å½“å‰é¡µé¢æ˜¾ç¤ºçš„å¡ç‰‡
                selectedIds.value = paginatedCards.value.map(c => c.id); 
            };
            
            const toggleTag = (tagName) => {
                currentTag.value = (currentTag.value === tagName ? null : tagName);
            };

            const addTag = (e) => {
                const v = e.target.value.trim();
                if(v && !activeCard.value.data.tags.includes(v)) {
                    activeCard.value.data.tags.push(v);
                    e.target.value = '';
                    saveCardToDB(activeCard.value);
                }
            };
            
            const deleteTag = (tagName) => {
                if(confirm(`ç¡®å®šä»æ‰€æœ‰å¡ç‰‡ä¸­ç§»é™¤æ ‡ç­¾ "${tagName}" å—ï¼Ÿ`)) {
                    cards.value.forEach(c => {
                        if(c.data.tags) {
                             const oldTags = [...c.data.tags];
                             c.data.tags = c.data.tags.filter(t => t.trim() !== tagName);
                             if (oldTags.length !== c.data.tags.length) saveCardToDB(c);
                        }
                    });
                    if(currentTag.value === tagName) currentTag.value = null;
                }
            };
            
            const renameTag = (oldName) => {
                const newName = prompt("è¯·è¾“å…¥æ–°æ ‡ç­¾å:", oldName);
                if(newName && newName.trim() !== oldName) {
                    const trimNew = newName.trim();
                    cards.value.forEach(c => {
                        if(c.data.tags && c.data.tags.includes(oldName)) {
                            c.data.tags = c.data.tags.filter(t => t !== oldName);
                            if(!c.data.tags.includes(trimNew)) c.data.tags.push(trimNew);
                            saveCardToDB(c);
                        }
                    });
                    if(currentTag.value === oldName) currentTag.value = trimNew;
                }
            };

            const openFolderModal = (mode, folderName = '', idx = -1) => {
                folderModal.value = {
                    visible: true,
                    isEdit: mode === 'edit',
                    name: folderName,
                    oldName: folderName,
                    index: idx
                };
            };

            const handleFolderSave = () => {
                const name = folderModal.value.name.trim();
                if(!name) { alert("åç§°ä¸èƒ½ä¸ºç©º"); return; }
                
                if(folderModal.value.isEdit) {
                    const oldName = folderModal.value.oldName;
                    if(name !== oldName) {
                        if(customFolders.value.includes(name)) { alert("åç§°å·²å­˜åœ¨"); return; }
                        customFolders.value[folderModal.value.index] = name;
                        cards.value.forEach(c => {
                            if(c.data.tags && c.data.tags.includes(oldName)) {
                                const idx = c.data.tags.indexOf(oldName);
                                c.data.tags[idx] = name;
                                saveCardToDB(c);
                            }
                        });
                        if(currentTag.value === oldName) currentTag.value = name;
                    }
                } else {
                    if(customFolders.value.includes(name)) { alert("æ–‡ä»¶å¤¹å·²å­˜åœ¨"); return; }
                    customFolders.value.push(name);
                }
                folderModal.value.visible = false;
            };

            const handleFolderDelete = () => {
                if(confirm("ç¡®å®šåˆ é™¤æ­¤æ–‡ä»¶å¤¹å—ï¼Ÿ")) {
                    const folderName = folderModal.value.oldName;
                    customFolders.value.splice(folderModal.value.index, 1);
                    if(currentTag.value === folderName) currentTag.value = null;
                    folderModal.value.visible = false;
                }
            };

            const getFolderCount = (folderName) => {
                return cards.value.filter(c => (c.data.tags || []).includes(folderName)).length;
            };
            
            const onDragStart = (e, card) => {
                let dragData = [];
                if(selectedIds.value.includes(card.id)) {
                    dragData = selectedIds.value;
                } else {
                    dragData = [card.id];
                }
                e.dataTransfer.setData('text/plain', JSON.stringify(dragData));
                e.dataTransfer.effectAllowed = 'copy';
            };

            const dragEnterFolder = (e) => { e.currentTarget.classList.add('drag-over'); };
            const dragLeaveFolder = (e) => { e.currentTarget.classList.remove('drag-over'); };

            const onDropToFolder = (e, folderName) => {
                e.currentTarget.classList.remove('drag-over');
                try {
                    const ids = JSON.parse(e.dataTransfer.getData('text/plain'));
                    if(Array.isArray(ids)) {
                        let count = 0;
                        cards.value.forEach(c => {
                            if(ids.includes(c.id)) {
                                if(!c.data.tags) c.data.tags = [];
                                if(!c.data.tags.includes(folderName)) {
                                    c.data.tags.push(folderName);
                                    saveCardToDB(c);
                                    count++;
                                }
                            }
                        });
                        if(count > 0) {
                            const temp = customFolders.value;
                            customFolders.value = [...temp]; 
                        }
                    }
                } catch(err) { console.error("Drop failed", err); }
            };

            const keepCard = async (keepId) => {
                const dropCard = diffCards.value.find(c => c.id !== keepId);
                const keepCard = diffCards.value.find(c => c.id === keepId);
                
                // æ£€æŸ¥è¢«åˆ é™¤çš„å¡æ˜¯å¦æœ‰å¿«é€Ÿå›å¤
                if (dropCard.quickReplies) {
                    const shouldTransfer = confirm('è¢«åˆ é™¤çš„å¡ç‰‡æœ‰å¿«é€Ÿå›å¤é…ç½®ï¼Œæ˜¯å¦è½¬ç§»åˆ°ä¿ç•™çš„å¡ç‰‡ï¼Ÿ');
                    if (shouldTransfer) {
                        keepCard.quickReplies = dropCard.quickReplies;
                        await saveCardToDB(keepCard);
                    }
                }
                
                await deleteCardFromDB(dropCard.id);
                cards.value = cards.value.filter(c => c.id !== dropCard.id);
                selectedIds.value = [keepId];
                showDiff.value = false;
            };

            // åœ¨é‡å¤é¡¹å¯¹æ¯”ä¸­è½¬ç§»å¿«é€Ÿå›å¤
            const transferQuickReplies = async (fromId, toId) => {
                const fromCard = cards.value.find(c => c.id === fromId);
                const toCard = cards.value.find(c => c.id === toId);
                
                if (!fromCard?.quickReplies) {
                    alert('æºå¡ç‰‡æ²¡æœ‰å¿«é€Ÿå›å¤é…ç½®');
                    return;
                }
                
                if (toCard.quickReplies) {
                    if (!confirm('ç›®æ ‡å¡ç‰‡å·²æœ‰å¿«é€Ÿå›å¤ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) {
                        return;
                    }
                }
                
                toCard.quickReplies = JSON.parse(JSON.stringify(fromCard.quickReplies));
                await saveCardToDB(toCard);
                alert('å¿«é€Ÿå›å¤å·²è½¬ç§»ï¼');
            };

            const batchDelete = async () => {
                if(confirm(`ç¡®å®šæ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ ${selectedIds.value.length} ä¸ªé¡¹ç›®?`)) {
                    for(const id of selectedIds.value) {
                        await deleteCardFromDB(id);
                    }
                    cards.value = cards.value.filter(c => !selectedIds.value.includes(c.id));
                    selectedIds.value = [];
                }
            };

            // å•å¡åˆ é™¤ï¼ˆä¸€æ¬¡ç¡®è®¤ï¼‰
            const deleteCardWithConfirm = async (id) => {
                const card = cards.value.find(c => c.id === id);
                if (!card) return;
                
                // ä¸€æ¬¡ç¡®è®¤
                if (!confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²å¡"${card.data.name}"å—ï¼Ÿ\n\næ–‡ä»¶å: ${card.fileName}\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
                    return;
                }
                
                await deleteCardFromDB(id);
                cards.value = cards.value.filter(c => c.id !== id);
                selectedIds.value = [];
                
                // æç¤ºåˆ é™¤æˆåŠŸ
                alert('âœ“ å·²åˆ é™¤');
            };

            // å¤åˆ¶å¡ç‰‡
            const duplicateCard = async (id) => {
                const originalCard = cards.value.find(c => c.id === id);
                if (!originalCard) return;
                
                // åˆ›å»ºå‰¯æœ¬
                const newCard = {
                    id: Math.random().toString(36).substr(2, 9),
                    fileName: originalCard.fileName.replace(/\.png$/, '_copy.png'),
                    importDate: Date.now(),
                    fileLastModified: originalCard.fileLastModified,
                    lastModified: Date.now(),
                    imgUrl: originalCard.imgUrl,
                    hasLore: originalCard.hasLore,
                    originalFile: originalCard.originalFile,
                    note: originalCard.note,
                    quickReplies: originalCard.quickReplies ? JSON.parse(JSON.stringify(originalCard.quickReplies)) : null,
                    data: JSON.parse(JSON.stringify(originalCard.data))
                };
                
                // ä¿®æ”¹åç§°æ ‡è®°ä¸ºå‰¯æœ¬
                newCard.data.name = originalCard.data.name + ' (å‰¯æœ¬)';
                
                await saveCardToDB(newCard);
                cards.value.push(newCard);
                selectedIds.value = [newCard.id];
                
                alert('âœ“ å·²å¤åˆ¶å¡ç‰‡');
            };

            const updateAvatar = (e) => {
                const f = e.target.files[0];
                if(f) {
                    activeCard.value.imgUrl = URL.createObjectURL(f);
                    activeCard.value.newAvatarFile = f;
                    saveCardToDB(activeCard.value);
                }
            };

            // å°†ä»»æ„å›¾ç‰‡æ ¼å¼è½¬æ¢ä¸ºPNG
            const convertImageToPng = (blob) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob((pngBlob) => {
                            if (pngBlob) resolve(pngBlob);
                            else reject(new Error('Failed to convert image to PNG'));
                        }, 'image/png');
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = URL.createObjectURL(blob);
                });
            };

            const exportSingle = async (card) => {
                try {
                    let blob = card.newAvatarFile || card.originalFile;
                    if(!blob && card.imgUrl) blob = await (await fetch(card.imgUrl)).blob();
                    if(!blob) {
                        alert("è¯·å…ˆæ·»åŠ å›¾ç‰‡æ‰èƒ½å¯¼å‡ºPNGæ ¼å¼!\nå¦‚éœ€å¯¼å‡ºæ— å›¾ç‰‡çš„JSONæ ¼å¼ï¼Œè¯·ç‚¹å‡»æ—è¾¹çš„JSONæŒ‰é’®ã€‚");
                        return;
                    }
                    
                    // å¦‚æœä¸æ˜¯PNG,è½¬æ¢ä¸ºPNG
                    if (blob.type !== 'image/png') {
                        blob = await convertImageToPng(blob);
                    }
                    
                    const exportData = { ...card.data, note: card.note || "" };
                    const finalBlob = await writePngMetadataSillyTavern(await blob.arrayBuffer(), { spec: "chara_card_v2", spec_version: "2.0", data: exportData });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(finalBlob); 
                    a.download = (card.fileName || card.data.name).replace(/\.(png|jpg|jpeg|webp|gif)$/i, '') + '.png'; 
                    a.click();
                } catch(e) { alert("å¯¼å‡ºé”™è¯¯: " + e.message); }
            };

            const exportJson = (card) => {
                const exportData = { ...card.data, note: card.note || "" };
                const json = JSON.stringify({ spec: "chara_card_v2", spec_version: "2.0", data: exportData }, null, 4);
                const blob = new Blob([json], { type: "application/json" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); 
                a.download = (card.data.name || 'card') + '.json'; a.click();
            };

            const batchExport = async () => {
                const targets = cards.value.filter(c => selectedIds.value.includes(c.id));
                if (targets.length === 0) return;
                isLoading.value = true;
                try {
                    const zip = new JSZip();
                    let count = 0;
                    for (const card of targets) {
                         try {
                            // è·å–å¡ç‰‡çš„ä¸»å›¾
                            let blob = card.newAvatarFile || card.originalFile;
                            if(!blob && card.imgUrl) blob = await (await fetch(card.imgUrl)).blob();
                            
                            const exportData = { ...card.data, note: card.note || "" };
                            
                            // è·å–å¡ç‰‡çš„æ ‡ç­¾(ä¼˜å…ˆæ–‡ä»¶å¤¹æ ‡ç­¾)
                            const cardTags = card.data.tags || [];
                            const folderTag = cardTags.find(tag => customFolders.value.includes(tag));
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰QRç  - ä¿®æ­£:æ£€æŸ¥quickReplies.data
                            const hasQR = card.quickReplies && card.quickReplies.data;
                            
                            // æ„å»ºæ–‡ä»¶è·¯å¾„
                            let folderPath = '';
                            if (folderTag) {
                                // ä½¿ç”¨æ–‡ä»¶å¤¹æ ‡ç­¾ä½œä¸ºçˆ¶æ–‡ä»¶å¤¹
                                folderPath = folderTag + '/';
                            }
                            
                            // å¦‚æœæœ‰å›¾ç‰‡,å¯¼å‡ºPNGæ ¼å¼
                            if (blob) {
                                // å¦‚æœä¸æ˜¯PNG,è½¬æ¢ä¸ºPNG
                                if (blob.type !== 'image/png') {
                                    blob = await convertImageToPng(blob);
                                }
                                
                                const finalBlob = await writePngMetadataSillyTavern(await blob.arrayBuffer(), { spec: "chara_card_v2", spec_version: "2.0", data: exportData });
                                const filename = (card.fileName || card.data.name).replace(/\.(png|jpg|jpeg|webp|gif)$/i, '') + '.png';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ è§’è‰²å¡ç‰‡
                                    zip.file(folderPath + filename, finalBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ ‡ç­¾æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + filename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${filename}`;
                                    zip.file(finalName, finalBlob);
                                }
                            } else {
                                // æ²¡æœ‰å›¾ç‰‡,å¯¼å‡ºJSONæ ¼å¼
                                const json = JSON.stringify({ spec: "chara_card_v2", spec_version: "2.0", data: exportData }, null, 4);
                                const jsonBlob = new Blob([json], { type: "application/json" });
                                const jsonFilename = (card.data.name || 'card') + '.json';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ JSONè§’è‰²å¡
                                    zip.file(folderPath + jsonFilename, jsonBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ ‡ç­¾æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + jsonFilename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${jsonFilename}`;
                                    zip.file(finalName, jsonBlob);
                                }
                            }
                            
                            count++;
                         } catch(e) { console.error("Export error", e); }
                    }
                    if (count > 0) {
                        const content = await zip.generateAsync({type:"blob"});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        a.download = `st_cards_export_${new Date().toISOString().slice(0,10)}.zip`;
                        a.click();
                    }
                } finally { isLoading.value = false; }
            };

            const batchExportAll = async () => {
                if (!confirm(`ç¡®å®šè¦æ‰“åŒ…æ‰€æœ‰ ${cards.value.length} ä¸ªå¡ç‰‡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) return;
                isLoading.value = true;
                try {
                    const zip = new JSZip();
                    let count = 0;
                    for (const card of cards.value) {
                         try {
                            // è·å–å¡ç‰‡çš„ä¸»å›¾
                            let blob = card.newAvatarFile || card.originalFile;
                            if(!blob && card.imgUrl) blob = await (await fetch(card.imgUrl)).blob();
                            
                            const exportData = { ...card.data, note: card.note || "" };
                            
                            // è·å–å¡ç‰‡çš„æ ‡ç­¾(ä¼˜å…ˆæ–‡ä»¶å¤¹æ ‡ç­¾)
                            const cardTags = card.data.tags || [];
                            const folderTag = cardTags.find(tag => customFolders.value.includes(tag));
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰QRç  - ä¿®æ­£:æ£€æŸ¥quickReplies.data
                            const hasQR = card.quickReplies && card.quickReplies.data;
                            
                            // æ„å»ºæ–‡ä»¶è·¯å¾„
                            let folderPath = '';
                            if (folderTag) {
                                // ä½¿ç”¨æ–‡ä»¶å¤¹æ ‡ç­¾ä½œä¸ºçˆ¶æ–‡ä»¶å¤¹
                                folderPath = folderTag + '/';
                            }
                            
                            // å¦‚æœæœ‰å›¾ç‰‡,å¯¼å‡ºPNGæ ¼å¼
                            if (blob) {
                                // å¦‚æœä¸æ˜¯PNG,è½¬æ¢ä¸ºPNG
                                if (blob.type !== 'image/png') {
                                    blob = await convertImageToPng(blob);
                                }
                                
                                const finalBlob = await writePngMetadataSillyTavern(await blob.arrayBuffer(), { spec: "chara_card_v2", spec_version: "2.0", data: exportData });
                                const filename = (card.fileName || card.data.name).replace(/\.(png|jpg|jpeg|webp|gif)$/i, '') + '.png';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ è§’è‰²å¡ç‰‡
                                    zip.file(folderPath + filename, finalBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ ‡ç­¾æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + filename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${filename}`;
                                    zip.file(finalName, finalBlob);
                                }
                            } else {
                                // æ²¡æœ‰å›¾ç‰‡,å¯¼å‡ºJSONæ ¼å¼
                                const json = JSON.stringify({ spec: "chara_card_v2", spec_version: "2.0", data: exportData }, null, 4);
                                const jsonBlob = new Blob([json], { type: "application/json" });
                                const jsonFilename = (card.data.name || 'card') + '.json';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ JSONè§’è‰²å¡
                                    zip.file(folderPath + jsonFilename, jsonBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ ‡ç­¾æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + jsonFilename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${jsonFilename}`;
                                    zip.file(finalName, jsonBlob);
                                }
                            }
                            
                            count++;
                         } catch(e) { console.error("Export error", e); }
                    }
                    if (count > 0) {
                        const content = await zip.generateAsync({type:"blob"});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        a.download = `st_cards_all_export_${new Date().toISOString().slice(0,10)}.zip`;
                        a.click();
                        alert(`âœ“ æˆåŠŸæ‰“åŒ… ${count} ä¸ªå¡ç‰‡`);
                    }
                } finally { isLoading.value = false; }
            };
            
            // å¯¼å‡ºå•ä¸ªå¡ç‰‡æˆ–æ•´ä¸ªæ”¶è—å¤¹
            const exportFolderOrSingle = async (exportFolder = false) => {
                if (!activeCard.value) return;
                
                isLoading.value = true;
                try {
                    const zip = new JSZip();
                    let targets = [];
                    
                    if (exportFolder) {
                        // å¯¼å‡ºæ•´ä¸ªæ”¶è—å¤¹
                        const cardTags = activeCard.value.data.tags || [];
                        const folderTag = cardTags.find(tag => customFolders.value.includes(tag));
                        
                        if (!folderTag) {
                            alert('æ­¤å¡ç‰‡ä¸å±äºä»»ä½•æ”¶è—å¤¹');
                            isLoading.value = false;
                            return;
                        }
                        
                        // è·å–è¯¥æ”¶è—å¤¹ä¸‹çš„æ‰€æœ‰å¡ç‰‡
                        targets = cards.value.filter(c => {
                            const tags = c.data.tags || [];
                            return tags.includes(folderTag);
                        });
                        
                        if (targets.length === 0) {
                            alert('æ”¶è—å¤¹ä¸­æ²¡æœ‰å¡ç‰‡');
                            isLoading.value = false;
                            return;
                        }
                    } else {
                        // åªå¯¼å‡ºå•å¼ å¡ç‰‡
                        targets = [activeCard.value];
                    }
                    
                    let count = 0;
                    for (const card of targets) {
                        try {
                            // è·å–å¡ç‰‡çš„ä¸»å›¾
                            let blob = card.newAvatarFile || card.originalFile;
                            if(!blob && card.imgUrl) blob = await (await fetch(card.imgUrl)).blob();
                            
                            const exportData = { ...card.data, note: card.note || "" };
                            
                            // è·å–å¡ç‰‡çš„æ ‡ç­¾(ä¼˜å…ˆæ–‡ä»¶å¤¹æ ‡ç­¾)
                            const cardTags = card.data.tags || [];
                            const folderTag = cardTags.find(tag => customFolders.value.includes(tag));
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰QRç 
                            const hasQR = card.quickReplies && card.quickReplies.data;
                            
                            // æ„å»ºæ–‡ä»¶è·¯å¾„ - å•å¡å¯¼å‡ºæ—¶ä¸ä½¿ç”¨æ”¶è—å¤¹è·¯å¾„
                            let folderPath = '';
                            if (exportFolder && folderTag) {
                                // å¯¼å‡ºæ”¶è—å¤¹æ—¶,ä½¿ç”¨æ–‡ä»¶å¤¹æ ‡ç­¾ä½œä¸ºçˆ¶æ–‡ä»¶å¤¹
                                folderPath = folderTag + '/';
                            }
                            
                            // å¦‚æœæœ‰å›¾ç‰‡,å¯¼å‡ºPNGæ ¼å¼
                            if (blob) {
                                // å¦‚æœä¸æ˜¯PNG,è½¬æ¢ä¸ºPNG
                                if (blob.type !== 'image/png') {
                                    blob = await convertImageToPng(blob);
                                }
                                
                                const finalBlob = await writePngMetadataSillyTavern(await blob.arrayBuffer(), { spec: "chara_card_v2", spec_version: "2.0", data: exportData });
                                const filename = (card.fileName || card.data.name).replace(/\.(png|jpg|jpeg|webp|gif)$/i, '') + '.png';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ è§’è‰²å¡ç‰‡
                                    zip.file(folderPath + filename, finalBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + filename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${filename}`;
                                    zip.file(finalName, finalBlob);
                                }
                            } else {
                                // æ²¡æœ‰å›¾ç‰‡,å¯¼å‡ºJSONæ ¼å¼
                                const json = JSON.stringify({ spec: "chara_card_v2", spec_version: "2.0", data: exportData }, null, 4);
                                const jsonBlob = new Blob([json], { type: "application/json" });
                                const jsonFilename = (card.data.name || 'card') + '.json';
                                
                                if (hasQR) {
                                    // å¦‚æœæœ‰QRç ,åˆ›å»ºä»¥è§’è‰²åå‘½åçš„å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    // æ·»åŠ JSONè§’è‰²å¡
                                    zip.file(folderPath + jsonFilename, jsonBlob);
                                    
                                    // æ·»åŠ QRç JSONæ–‡ä»¶
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || (card.data.name || 'quick_replies') + '.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    // æ²¡æœ‰QRç ,ç›´æ¥æ”¾åœ¨æ–‡ä»¶å¤¹ä¸‹
                                    let finalName = folderPath + jsonFilename;
                                    // é¿å…æ–‡ä»¶åå†²çª
                                    if(zip.file(finalName)) finalName = folderPath + `${Date.now()}_${jsonFilename}`;
                                    zip.file(finalName, jsonBlob);
                                }
                            }
                            
                            count++;
                        } catch(e) { 
                            console.error("Export error", e); 
                        }
                    }
                    
                    if (count > 0) {
                        const content = await zip.generateAsync({type:"blob"});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        
                        if (exportFolder) {
                            const cardTags = activeCard.value.data.tags || [];
                            const folderTag = cardTags.find(tag => customFolders.value.includes(tag));
                            a.download = `${folderTag}_${new Date().toISOString().slice(0,10)}.zip`;
                        } else {
                            a.download = `${activeCard.value.data.name || 'card'}_${new Date().toISOString().slice(0,10)}.zip`;
                        }
                        
                        a.click();
                        alert(`âœ“ æˆåŠŸå¯¼å‡º ${count} ä¸ªå¡ç‰‡`);
                    }
                } finally { 
                    isLoading.value = false; 
                }
            };

            const applyBatchEdit = () => {
                if(!confirm(`ç¡®è®¤ä¿®æ”¹ ${selectedIds.value.length} ä¸ªè§’è‰²?`)) return;
                cards.value.forEach(c => {
                    if(selectedIds.value.includes(c.id)) {
                        if(batchForm.value.creator) c.data.creator = batchForm.value.creator;
                        if(batchForm.value.tagsToAdd) {
                            const newTags = batchForm.value.tagsToAdd.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t);
                            c.data.tags = [...new Set([...(c.data.tags||[]), ...newTags])];
                        }
                        saveCardToDB(c);
                    }
                });
                showBatchModal.value = false;
                selectedIds.value = [];
            };

            const addAlternate = () => {
                if (!activeCard.value.data.alternate_greetings) {
                    activeCard.value.data.alternate_greetings = [];
                }
                activeCard.value.data.alternate_greetings.push("");
                saveCardToDB(activeCard.value);
            };

            const removeAlternate = (idx) => {
                if (confirm("ç¡®å®šç§»é™¤è¿™æ¡å¤‡é€‰å¼€åœºç™½å—ï¼Ÿ")) {
                    activeCard.value.data.alternate_greetings.splice(idx, 1);
                    saveCardToDB(activeCard.value);
                }
            };
            
            // --- World Info Logic ---
            const openWorldInfo = () => {
                if(!activeCard.value.data.character_book) activeCard.value.data.character_book = { entries: [] };
                if(!activeCard.value.data.character_book.entries) activeCard.value.data.character_book.entries = [];
                wiModal.value.entries = activeCard.value.data.character_book.entries;
                wiModal.value.selectedIndex = -1;
                wiModal.value.visible = true;
            };
            const addWiEntry = () => {
                activeCard.value.data.character_book.entries.push({ keys: ['new_entry'], content: '', enabled: true, insertion_order: 100, case_sensitive: false, priority: 0 });
                wiModal.value.selectedIndex = activeCard.value.data.character_book.entries.length - 1;
                saveCardToDB(activeCard.value);
            };
            const updateWiKeys = (idx) => {
                const val = wiModal.value.entries[idx].keysInput;
                if(val) wiModal.value.entries[idx].keys = val.split(',').map(k => k.trim()).filter(k=>k);
            };
            watch(() => wiModal.value.selectedIndex, (newIdx) => {
                if(newIdx > -1 && wiModal.value.entries[newIdx]) {
                    wiModal.value.entries[newIdx].keysInput = (wiModal.value.entries[newIdx].keys || []).join(', ');
                }
            });
            const deleteWiEntry = (idx) => {
                if(confirm("åˆ é™¤æ­¤è¯æ¡?")) {
                    activeCard.value.data.character_book.entries.splice(idx, 1);
                    wiModal.value.selectedIndex = -1;
                    saveCardToDB(activeCard.value);
                }
            };
            watch(() => wiModal.value.entries, () => { if(wiModal.value.visible) saveCardToDB(activeCard.value); }, { deep: true });

            // --- Regex Logic ---
            const openRegex = () => {
                // Ensure regex struct. Supports 'extensions.regex_scripts' (ST standard) or root 'regex_scripts'
                if(!activeCard.value.data.extensions) activeCard.value.data.extensions = {};
                if(!activeCard.value.data.extensions.regex_scripts) {
                    // check legacy
                    if(activeCard.value.data.regex_scripts) activeCard.value.data.extensions.regex_scripts = activeCard.value.data.regex_scripts;
                    else activeCard.value.data.extensions.regex_scripts = [];
                }
                regexModal.value.scripts = activeCard.value.data.extensions.regex_scripts;
                regexModal.value.selectedIndex = -1;
                regexModal.value.visible = true;
            };
            const addRegexScript = () => {
                regexModal.value.scripts.push({ scriptName: 'New Script', regex: '', regexReplacement: '', regexPlacement: 1, regexFlags: 'gm' });
                regexModal.value.selectedIndex = regexModal.value.scripts.length - 1;
                saveCardToDB(activeCard.value);
            };
            const deleteRegexScript = (idx) => {
                 if(confirm("åˆ é™¤æ­¤è„šæœ¬?")) {
                    regexModal.value.scripts.splice(idx, 1);
                    regexModal.value.selectedIndex = -1;
                    saveCardToDB(activeCard.value);
                }
            };
             const runRegexTest = (script, text) => {
                if(!script || !script.regex || !text) return text;
                try {
                    // ST Regex is Python. JS is slightly different.
                    const flags = script.regexFlags || 'gm';
                    const re = new RegExp(script.regex, flags);
                    return text.replace(re, (match, ...args) => {
                        let replacement = script.regexReplacement || '';
                        // Simple Python group backref ($1, $2) support is native to JS replace string, but complex python logic isn't.
                        // However, JS uses $1, Python uses \1 usually. ST allows both or $1.
                        // Let's assume standard JS replace behavior for simulation.
                        return replacement.replace(/\\(\d+)/g, '$$$1'); // Convert \1 to $1 for JS if needed
                    });
                } catch(e) { return "Regex Error: " + e.message; }
            };
            watch(() => regexModal.value.scripts, () => { if(regexModal.value.visible) saveCardToDB(activeCard.value); }, { deep: true });

            // Watch for text changes to auto-save
            watch(() => activeCard.value?.data.description, () => { if(activeCard.value) saveCardToDB(activeCard.value); });
            watch(() => activeCard.value?.data.name, () => { if(activeCard.value) saveCardToDB(activeCard.value); });
            watch(() => activeCard.value?.data.first_mes, () => { if(activeCard.value) saveCardToDB(activeCard.value); });

            // URL validation helper
            const isValidUrl = (str) => {
                if (!str) return false;
                try {
                    const url = new URL(str);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch {
                    return false;
                }
            };

            // NEW: Helper functions for comparison stats
            const getFirstMessagesCount = (card) => {
                return 1 + (card.data.alternate_greetings?.length || 0);
            };

            const getFirstMessagesCharCounts = (card) => {
                const counts = [(card.data.first_mes?.length || 0)];
                if (card.data.alternate_greetings) {
                    card.data.alternate_greetings.forEach(alt => {
                        counts.push(alt?.length || 0);
                    });
                }
                return counts;
            };

            const getWorldInfoCount = (card) => {
                return card.data.character_book?.entries?.length || 0;
            };

            const getWorldInfoTotalChars = (card) => {
                if (!card.data.character_book?.entries) return 0;
                return card.data.character_book.entries.reduce((total, entry) => {
                    return total + (entry.content?.length || 0);
                }, 0);
            };
            
            // å¯¼å‡ºæŒ‡å®šæ–‡ä»¶å¤¹çš„æ‰€æœ‰å¡ç‰‡
            const exportFolder = async (folderName) => {
                if (!folderName) return;
                
                // è·å–è¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å¡ç‰‡
                const folderCards = cards.value.filter(c => {
                    const tags = c.data.tags || [];
                    return tags.includes(folderName);
                });
                
                if (folderCards.length === 0) {
                    alert(`æ–‡ä»¶å¤¹ã€Œ${folderName}ã€ä¸­æ²¡æœ‰å¡ç‰‡`);
                    return;
                }
                
                if (!confirm(`ç¡®å®šè¦å¯¼å‡ºæ–‡ä»¶å¤¹ã€Œ${folderName}ã€ä¸­çš„ ${folderCards.length} ä¸ªå¡ç‰‡å—ï¼Ÿ`)) return;
                
                isLoading.value = true;
                try {
                    const zip = new JSZip();
                    let count = 0;
                    
                    for (const card of folderCards) {
                        try {
                            // è·å–å¡ç‰‡çš„ä¸»å›¾
                            let blob = card.newAvatarFile || card.originalFile;
                            if(!blob && card.imgUrl) blob = await (await fetch(card.imgUrl)).blob();
                            
                            const exportData = { ...card.data, note: card.note || "" };
                            const hasQR = card.quickReplies && card.quickReplies.data;
                            
                            // æ„å»ºæ–‡ä»¶è·¯å¾„
                            let folderPath = folderName + '/';
                            
                            // å¦‚æœæœ‰å›¾ç‰‡,å¯¼å‡ºPNGæ ¼å¼
                            if (blob) {
                                // å¦‚æœä¸æ˜¯PNG,è½¬æ¢ä¸ºPNG
                                if (blob.type !== 'image/png') {
                                    blob = await convertImageToPng(blob);
                                }
                                
                                const finalBlob = await writePngMetadataSillyTavern(await blob.arrayBuffer(), { 
                                    spec: card.originalSpec || 'chara_card_v2', 
                                    spec_version: card.originalSpecVersion || '2.0', 
                                    data: exportData 
                                });
                                const filename = (card.fileName || card.data.name).replace(/\.(png|jpg|jpeg|webp|gif)$/i, '') + '.png';
                                
                                if (hasQR) {
                                    // æœ‰QRç ,åˆ›å»ºè§’è‰²å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.png$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    zip.file(folderPath + filename, finalBlob);
                                    
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || 'quick_replies.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    zip.file(folderPath + filename, finalBlob);
                                }
                            } else {
                                // æ²¡æœ‰å›¾ç‰‡,å¯¼å‡ºJSONæ ¼å¼
                                const json = JSON.stringify({ 
                                    spec: card.originalSpec || 'chara_card_v2', 
                                    spec_version: card.originalSpecVersion || '2.0', 
                                    data: exportData 
                                }, null, 4);
                                const jsonBlob = new Blob([json], { type: "application/json" });
                                const jsonFilename = (card.data.name || 'card') + '.json';
                                
                                if (hasQR) {
                                    // æœ‰QRç ,åˆ›å»ºè§’è‰²å­æ–‡ä»¶å¤¹
                                    const characterFolderName = (card.data.name || card.fileName.replace(/\.json$/i, '')).replace(/[/\\?%*:|"<>]/g, '_');
                                    folderPath += characterFolderName + '/';
                                    
                                    zip.file(folderPath + jsonFilename, jsonBlob);
                                    
                                    const qrJson = JSON.stringify(card.quickReplies.data, null, 2);
                                    const qrBlob = new Blob([qrJson], { type: 'application/json' });
                                    const qrFileName = card.quickReplies.fileName || 'quick_replies.json';
                                    zip.file(folderPath + qrFileName, qrBlob);
                                } else {
                                    zip.file(folderPath + jsonFilename, jsonBlob);
                                }
                            }
                            
                            count++;
                        } catch(e) { 
                            console.error("Export error", e); 
                        }
                    }
                    
                    if (count > 0) {
                        const content = await zip.generateAsync({type:"blob"});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(content);
                        a.download = `${folderName}_${new Date().toISOString().slice(0,10)}.zip`;
                        a.click();
                        alert(`âœ“ æˆåŠŸå¯¼å‡º ${count} ä¸ªå¡ç‰‡`);
                        selectedFolderForExport.value = null; // æ¸…é™¤é€‰æ‹©
                    }
                } finally { 
                    isLoading.value = false; 
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            return {
                cards, selectedIds, isEditMode, search, viewMode, currentTag, sortBy, showDiff, showBatchModal, batchForm, tagManageMode, customFolders, selectedFolderForExport, showFirstMesModal, viewingAltIndex, isLoading, firstMesPreview,
                importErrors, showErrorModal, folderModal, wiModal, regexModal,
                // QR ç›¸å…³
                availableQRs, pendingQRBind, showQRSection, qrManageMode, selectedQRIds, showTagSection,
                itemsPerPage, currentPage, pageJumpInput, paginatedCards, totalPages, // Pagination Return
                allTags, filteredCards, duplicateCount, activeCard, diffCards, groupedCards, duplicateGroupsList, paginatedGroups, currentBigGreeting,
                handleImport, handleCardClick, selectAll, addTag, toggleTag, deleteTag, renameTag, keepCard, transferQuickReplies, batchDelete, deleteCardWithConfirm, duplicateCard, updateAvatar, exportSingle, exportJson, batchExport, batchExportAll, exportFolderOrSingle, exportFolder, applyBatchEdit,
                getFolderCount, onDragStart, onDropToFolder, dragEnterFolder, dragLeaveFolder,
                addAlternate, removeAlternate,
                openFolderModal, handleFolderSave, handleFolderDelete,
                setPage,
                openWorldInfo, addWiEntry, deleteWiEntry, updateWiKeys,
                openRegex, addRegexScript, deleteRegexScript, runRegexTest,
                isValidUrl,
                getFirstMessagesCount, getFirstMessagesCharCounts, getWorldInfoCount, getWorldInfoTotalChars, formatDate,
                handleFolderImport, importQuickReplies, removeQuickReplies, downloadQuickReplies,
                // QR æ‹–æ‹½ç›¸å…³å‡½æ•°
                handleQRImport, removeQRFromList, toggleQRSelection, batchDeleteQR, onQRDragStart, onQRDragEnter, onQRDragLeave, onQRDrop, confirmQRBind, cancelQRBind
            };
        },
        mounted() { lucide.createIcons(); },
        updated() { nextTick(() => lucide.createIcons()); }
    }).mount('#app');

    async function writePngMetadataSillyTavern(arrayBuffer, jsonData) {
        const chunks = [];
        const view = new DataView(arrayBuffer);
        let offset = 8;
        chunks.push(arrayBuffer.slice(0, 8));
        while (offset < arrayBuffer.byteLength) {
            const length = view.getUint32(offset);
            const type = String.fromCharCode(...new Uint8Array(arrayBuffer.slice(offset + 4, offset + 8)));
            if (type === 'IEND') break;
            chunks.push(arrayBuffer.slice(offset, offset + 12 + length));
            offset += 12 + length;
        }
        const textKey = "chara";
        const textVal = btoa(unescape(encodeURIComponent(JSON.stringify(jsonData))));
        const textContent = textKey + "\0" + textVal;
        const textChunkLen = textContent.length;
        const newChunk = new Uint8Array(12 + textChunkLen);
        const ncView = new DataView(newChunk.buffer);
        ncView.setUint32(0, textChunkLen);
        newChunk.set(new Uint8Array(textContent.split('').map(c => c.charCodeAt(0))), 8);
        const typeBytes = new Uint8Array([116, 69, 88, 116]);
        newChunk.set(typeBytes, 4);
        ncView.setUint32(8 + textChunkLen, crc32(newChunk.slice(4, 8 + textChunkLen)));
        chunks.push(newChunk.buffer);
        chunks.push(new Uint8Array([0,0,0,0,73,69,78,68,174,66,96,130]).buffer);
        return new Blob(chunks, { type: 'image/png' });
    }

    function crc32(Uint8Arr) {
        let crcTable = window.crcTable || (window.crcTable = (() => {
            let c, n, k, table = [];
            for (n = 0; n < 256; n++) {
                c = n;
                for (k = 0; k < 8; k++) c = ((c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1));
                table[n] = c;
            }
            return table;
        })());
        let crc = 0 ^ (-1);
        for (let i = 0; i < Uint8Arr.length; i++) crc = (crc >>> 8) ^ crcTable[(crc ^ Uint8Arr[i]) & 0xFF];
        return (crc ^ (-1)) >>> 0;
    }
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
